<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Rebanho Leiteiro - Meu App Completo</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>

    <style>
        /* Copiado integralmente do estilo original (mantive todos os estilos e adicionei pequenos ajustes visuais para timeline e histórico) */
        :root {
            --primary-color: #28a745; /* Verde principal */
            --secondary-color: #007bff; /* Azul secundário */
            --accent-color: #ffc107; /* Amarelo de destaque/alerta */
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .header h1 .ph {
            margin-right: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* --- Navegação --- */
        .nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-link {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
            transition: all 0.2s;
            background-color: white;
            border: 1px solid var(--primary-color);
            display: flex;
            align-items: center;
        }

        .nav-link:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .nav-link .ph {
            margin-right: 8px;
            font-size: 1.1rem;
        }

        /* --- Seções da Página --- */
        .page-section {
            display: none;
        }

        .section-title {
            font-size: 1.75rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        /* --- Cards --- */
        .card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary-color);
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            margin-top: 1rem;
        }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            text-align: center;
            border-left: 5px solid var(--secondary-color);
            padding: 1.5rem;
        }

        .metric-card.success {
            border-left-color: var(--success-color);
        }
        .metric-card.warning {
            border-left-color: var(--warning-color);
        }
        .metric-card.danger {
            border-left-color: var(--danger-color);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--secondary-color);
            line-height: 1;
        }
        .metric-card.success .metric-value { color: var(--success-color); }
        .metric-card.warning .metric-value { color: var(--warning-color); }
        .metric-card.danger .metric-value { color: var(--danger-color); }

        .metric-label {
            font-size: 1rem;
            color: #6c757d;
            margin-top: 5px;
            font-weight: 500;
        }

        /* --- Formulários e Botões --- */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        input:not([type="checkbox"]), select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn .ph {
            margin-right: 8px;
            font-size: 1.1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #218838;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        
        .btn-info:hover {
             background-color: #117a8b;
        }
        
        .btn-sm {
            padding: 0.5rem 0.8rem;
            font-size: 0.875rem;
        }

        /* --- Tabela --- */
        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .data-table tbody tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        /* --- Modal --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Controlado via JS */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* Ajuste para o Modal de Relatórios ser um pouco maior */
        #modal-relatorios-pdf .modal-content {
            max-width: 700px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        /* --- Alerta Personalizado (Global) --- */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .custom-alert-box {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            width: 350px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .custom-alert-overlay.show {
            opacity: 1;
        }
        
        .custom-alert-overlay.show .custom-alert-box {
            transform: translateY(0);
        }

        .custom-alert-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .custom-alert-message {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .custom-alert-box.confirm .custom-alert-icon {
            color: var(--warning-color);
        }
        
        .custom-alert-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        /* --- Visualização do Animal --- */
        .animal-view-data {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .animal-photo-container {
            text-align: center;
        }
        
        .animal-photo-container img {
            width: 100%;
            max-width: 250px;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 1rem;
            border: 4px solid #e9ecef;
        }

        .animal-thumb {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            display: inline-block;
        }
            .animal-details dt {
            font-weight: 700;
            color: var(--secondary-color);
            margin-top: 1rem;
            font-size: 0.95rem;
            text-transform: uppercase;
        }
        .animal-details dd {
            margin-left: 0;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        /* Tabs para Visualização do Animal */
        .animal-view-tabs {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .animal-view-tab-btn {
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .animal-view-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .animal-view-tab-content {
            padding: 1rem 0;
            display: none;
        }

        /* Timeline (Histórico de Eventos) */
        .timeline {
            position: relative;
            margin: 20px 0;
            padding: 0;
        }

        .timeline:before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
            left: 20px;
            margin-left: -1.5px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 50px;
            min-height: 50px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            left: 13px;
            top: 5px;
            background: white;
            border: 3px solid var(--secondary-color);
            z-index: 1;
        }
        
        .timeline-item.parto::before { border-color: var(--success-color); }
        .timeline-item.cio::before { border-color: var(--warning-color); }
        .timeline-item.cobertura::before { border-color: var(--info-color); }
        .timeline-item.diagnostico::before { border-color: var(--primary-color); }
        .timeline-item.morte::before { border-color: var(--danger-color); }

        .timeline-date {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
        }

        .timeline-content {
            background: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-top: 5px;
        }
        
        .timeline-content h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1rem;
            color: var(--secondary-color);
        }

        /* --- Tarefas (Lista) --- */
        .tarefa-list {
            list-style: none;
            padding: 0;
        }

        .tarefa-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-background);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            border-left: 5px solid var(--warning-color);
        }

        .tarefa-item.done {
            border-left-color: var(--success-color);
            opacity: 0.7;
            text-decoration: line-through;
            background-color: #e9f5e9;
        }

        .tarefa-info {
            flex-grow: 1;
        }

        .tarefa-info strong {
            display: block;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .tarefa-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .tarefa-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Câmera/Foto Preview */
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
        }
        .camera-container video, .camera-container canvas {
            width: 100%;
            max-width: 400px;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
        }
        #foto-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav {
                justify-content: center;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .animal-view-data {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1><i class="ph ph-cow"></i> Gerenciador de Rebanho Leiteiro</h1>
        <div class="header-actions">
             <button class="btn btn-warning btn-sm" id="btn-exportar-csv"><i class="ph ph-file-csv"></i> Exportar CSV</button>
            <button class="btn btn-secondary btn-sm" id="btn-exportar-json"><i class="ph ph-export"></i> Exportar Dados (JSON)</button>
            <button class="btn btn-info btn-sm" id="btn-importar-dados-modal"><i class="ph ph-import"></i> Importar Dados</button>
            <button class="btn btn-danger btn-sm" id="reset-data-btn"><i class="ph ph-skull"></i> Resetar Tudo</button>
        </div>
    </header>

    <div class="container">
        <nav class="nav">
            <a href="#dashboard" class="nav-link active" data-section="dashboard"><i class="ph ph-chart-bar"></i> Dashboard</a>
            <a href="#animais" class="nav-link" data-section="animais"><i class="ph ph-list-numbers"></i> Animais</a>
            <a href="#producao" class="nav-link" data-section="producao"><i class="ph ph-bucket-simple"></i> Produção de Leite</a>
            <a href="#saude" class="nav-link" data-section="saude"><i class="ph ph-calendar-check"></i> Saúde e Reprodução</a>
            <a href="#config" class="nav-link" data-section="config"><i class="ph ph-gear-six"></i> Configurações</a>
        </nav>

        <section id="dashboard" class="page-section active">
            <h2 class="section-title">Dashboard</h2>

            <div class="dashboard-grid">
                <div class="card metric-card success">
                    <div class="metric-value" id="total-animais">0</div>
                    <div class="metric-label">Total de Animais</div>
                </div>
                <div class="card metric-card info">
                    <div class="metric-value" id="vacas-lactacao">0</div>
                    <div class="metric-label">Vacas em Lactação</div>
                </div>
                <div class="card metric-card warning">
                    <div class="metric-value" id="tarefas-pendentes">0</div>
                    <div class="metric-label">Tarefas Pendentes</div>
                </div>
                <div class="card metric-card primary">
                    <div class="metric-value" id="producao-media-diaria">0 L</div>
                    <div class="metric-label">Média Diária (Últimos 7 dias)</div>
                </div>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <div class="card-header">Produção Diária (Últimas 4 Semanas)</div>
                    <div class="card-body">
                        <canvas id="producaoDiariaChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Próximas Tarefas</div>
                    <div class="card-body">
                        <ul class="tarefa-list" id="proximas-tarefas-lista">
                            <p class="text-secondary">Nenhuma tarefa pendente.</p>
                        </ul>
                        <button class="btn btn-primary btn-sm" onclick="showSection('saude')"><i class="ph ph-plus"></i> Gerenciar Tarefas</button>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">Próximos Eventos de Reprodução</div>
                    <div class="card-body">
                        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                            <div>
                                <h4 style="color:var(--danger-color);">Próximos Partos (30 dias)</h4>
                                <ul class="tarefa-list" id="proximos-partos-lista">
                                    </ul>
                            </div>
                            <div>
                                <h4 style="color:var(--warning-color);">Próximos Cio (30 dias)</h4>
                                <ul class="tarefa-list" id="proximos-cio-lista">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">Distribuição do Rebanho por Categoria</div>
                    <div class="card-body" style="max-width: 500px; margin: 0 auto;">
                        <canvas id="distribuicaoRebanhoChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="animais" class="page-section">
            <h2 class="section-title">Cadastro de Animais</h2>

            <div class="card">
                <div class="card-header">
                    Lista de Animais
                    <button class="btn btn-primary" id="btn-novo-animal" onclick="openAnimalForm()"><i class="ph ph-plus"></i> Novo Animal</button>
                </div>
                <div class="card-body">
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="busca-animal" placeholder="Buscar por ID ou Nome...">
                        <select id="filtro-categoria">
                            <option value="">Todas as Categorias</option>
                            <option value="Vaca">Vaca</option>
                            <option value="Novilha">Novilha</option>
                            <option value="Bezerro(a)">Bezerro(a)</option>
                            <option value="Boi">Boi</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                   <th>ID</th>
                                   <th>Foto</th>
                                   <th>Nome</th>
                                   <th>Sexo</th>
                                   <th>Pai / Mãe</th>
                                   <th>Categoria</th>
                                    <th>Idade</th>
                                    <th>Status Repr.</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="animal-list-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="producao" class="page-section">
            <h2 class="section-title">Registro de Produção de Leite</h2>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">Registrar Produção Diária</div>
                    <div class="card-body">
                        <form id="leite-form">
                            <div class="form-group">
                                <label for="leite-data-input">Data:</label>
                                <input type="date" id="leite-data-input" required>
                            </div>
                             <div class="form-group">
                                <label for="leite-periodo-select">Período:</label>
                                <select id="leite-periodo-select" required>
                                    <option value="manha">Manhã</option>
                                    <option value="tarde">Tarde</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leite-vaca-select">Vaca (em Lactação):</label>
                                <select id="leite-vaca-select" required>
                                    </select>
                            </div>
                            <div class="form-group">
                                <label for="leite-quantidade-input">Quantidade (Litros):</label>
                                <input type="number" id="leite-quantidade-input" step="0.1" min="0.1" required>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="ph ph-floppy-disk"></i> Salvar Produção</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Últimos Registros de Leite</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Vaca</th>
                                        <th>Período</th>
                                        <th>Litros</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="leite-list-tbody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="saude" class="page-section">
            <h2 class="section-title">Saúde e Reprodução (Tarefas)</h2>

            <div class="dashboard-grid" style="grid-template-columns: 1fr 2fr;">
                <div class="card">
                    <div class="card-header">Registrar Nova Tarefa</div>
                    <div class="card-body">
                        <form id="tarefa-form">
                            <div class="form-group">
                                <label for="tarefa-animal-select">Animal:</label>
                                <select id="tarefa-animal-select" required>
                                    </select>
                            </div>
                            <div class="form-group">
                                <label for="tarefa-tipo-select">Tipo de Tarefa/Evento:</label>
                                <select id="tarefa-tipo-select" required>
                                    <option value="vacina">Vacinação</option>
                                    <option value="vermifugo">Vermifugação</option>
                                    <option value="cio">Previsão de Cio</option>
                                    <option value="parto">Previsão de Parto</option>
                                    <option value="cobertura">Cobertura/Inseminação</option>
                                    <option value="diagnostico">Diagnóstico de Gestação</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tarefa-data">Data Limite/Previsão:</label>
                                <input type="date" id="tarefa-data" required>
                            </div>
                            <div class="form-group">
                                <label for="tarefa-descricao">Detalhes:</label>
                                <textarea id="tarefa-descricao" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="ph ph-plus"></i> Adicionar Tarefa</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Lista de Tarefas Pendentes</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Animal</th>
                                        <th>Tipo</th>
                                        <th>Detalhes</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tarefa-list-tbody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="config" class="page-section">
            <h2 class="section-title">Configurações e Manutenção</h2>

            <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="card-header">Configurações Gerais</div>
                    <div class="card-body">
                         <form id="id-prefix-form" class="form-inline">
                            <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                                <div>
                                    <label for="id-prefix-input">Prefixo de ID do Animal (1-5 letras):</label>
                                    <input type="text" id="id-prefix-input" maxlength="5" placeholder="Ex: VACA" style="width: 150px;">
                                </div>
                                <button type="submit" class="btn btn-secondary"><i class="ph ph-floppy-disk"></i> Salvar Prefixo</button>
                            </div>
                             <p style="font-size: 0.9em; color: #6c757d;">Prefixo atual: <span id="current-id-prefix"></span></p>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Backup e Restauração de Dados</div>
                    <div class="card-body">
                        <button class="btn btn-secondary" onclick="exportDataToJson()"><i class="ph ph-export"></i> Exportar Dados (JSON)</button>
                        <p style="margin-top: 15px;">Importar Dados (Substitui TODOS os dados existentes):</p>
                        <input type="file" id="input-importar-dados" accept=".json, .csv" style="width: auto; margin-right: 10px;">
                        <button class="btn btn-danger" id="btn-importar-dados" disabled><i class="ph ph-import"></i> Importar/Restaurar</button>
                        <button class="btn btn-warning" id="btn-importar-csv-modal"><i class="ph ph-file-csv"></i> Importar CSV</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Relatórios</div>
                    <div class="card-body">
                        <button class="btn btn-info" id="btn-abrir-modal-relatorio"><i class="ph ph-file-pdf"></i> Gerar Relatório PDF</button>
                    </div>
                </div>
            </div>
        </section>


        <div id="modal-animal-form" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="document.getElementById('modal-animal-form').style.display='none'">&times;</span>
                <h3 style="color:var(--secondary-color);">Formulário de Animal</h3>
                <form id="animal-form">
                    <input type="hidden" id="animal-id">

                    <div class="form-group">
                        <label for="animal-nome">Nome/Identificação:</label>
                        <input type="text" id="animal-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="animal-raca">Raça:</label>
                        <input type="text" id="animal-raca" required>
                    </div>
                    <div class="form-group">
                        <label for="animal-categoria-select">Categoria:</label>
                        <select id="animal-categoria-select" required>
                            <option value="">Selecione...</option>
                            <option value="Vaca">Vaca</option>
                            <option value="Novilha">Novilha</option>
                            <option value="Bezerro(a)">Bezerro(a)</option>
                            <option value="Boi">Boi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="animal-sexo-select">Sexo:</label>
                        <select id="animal-sexo-select" required>
                           <option value="">Selecione...</option>
                            <option value="Fêmea">Fêmea</option>
                            <option value="Macho">Macho</option>
                            <option value="Indefinido">Indefinido</option>
                        </select>
                    </div>
                      <!-- Campos Pai / Mãe: selecionar entre animais já cadastrados -->
                        <div class="form-group" style="display:flex; gap:10px;">
                            <div style="flex:1;">
                                <label for="parent-pai-select">Pai (Sire):</label>
                                <select id="parent-pai-select">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label for="parent-mae-select">Mãe (Dam):</label>
                                <select id="parent-mae-select">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                        </div>

                    <div class="form-group">
                        <label for="animal-peso">Peso (Kg):</label>
                        <input type="number" id="animal-peso" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="animal-data-nasc">Data de Nascimento:</label>
                        <input type="date" id="animal-data-nasc" required>
                    </div>
                    <div class="form-group">
                        <label for="animal-data-aquisicao">Data de Aquisição:</label>
                        <input type="date" id="animal-data-aquisicao">
                    </div>

                    <div id="vaca-fields" style="display: none; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                        <h4>Detalhes de Reprodução</h4>
                        <div class="form-group">
                            <label for="animal-status-reprodutivo">Status Reprodutivo:</label>
                            <select id="animal-status-reprodutivo" required>
                                <option value="Vazia">Vazia</option>
                                <option value="Prenhe">Prenhe</option>
                                <option value="Em Lactação">Em Lactação</option>
                                <option value="Seca">Seca</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="animal-data-ultimo-parto">Data Último Parto:</label>
                            <input type="date" id="animal-data-ultimo-parto">
                        </div>
                        <div class="form-group">
                            <label for="animal-data-secagem">Data de Secagem (Prevista/Real):</label>
                            <input type="date" id="animal-data-secagem">
                        </div>
                        <div class="form-group">
                            <label for="animal-data-previsao-parto">Data Prevista do Próximo Parto:</label>
                            <input type="date" id="animal-data-previsao-parto">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="animal-foto-input">Foto do Animal:</label>
                        <div class="camera-container">
                            <input type="file" id="animal-foto-input" accept="image/*" onchange="previewFoto(event)">
                            <img id="foto-preview" src="" alt="Preview da Foto" style="display: none;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="capturarImagem()"><i class="ph ph-camera"></i> Capturar com Câmera</button>
                            <video id="camera-video" style="display: none;" autoplay></video>
                            <canvas id="camera-canvas" style="display: none;"></canvas>
                            <button type="button" class="btn btn-info btn-sm" id="btn-tirar-foto" style="display: none;"><i class="ph ph-aperture"></i> Tirar Foto</button>
                            <button type="button" class="btn btn-danger btn-sm" id="btn-cancelar-camera" style="display: none;"><i class="ph ph-x-circle"></i> Cancelar Câmera</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 1rem;"><i class="ph ph-floppy-disk"></i> Salvar Animal</button>
                </form>
            </div>
        </div>

        <div id="modal-animal-view" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="document.getElementById('modal-animal-view').style.display='none'">&times;</span>
                <h3 style="color:var(--primary-color);" id="view-animal-title">Detalhes do Animal</h3>
                <div class="animal-view-data">
                    <div class="animal-photo-container">
                        <img id="view-animal-foto" src="" alt="Foto do Animal">
                        <button class="btn btn-warning btn-sm" id="btn-edit-view"><i class="ph ph-pencil"></i> Editar</button>
                        <button class="btn btn-danger btn-sm" id="btn-delete-view"><i class="ph ph-trash"></i> Excluir</button>
                    </div>
                    <dl class="animal-details" id="view-animal-details">
                        </dl>
                </div>
                <div class="animal-view-tabs" id="animal-view-tabs">
                    <button class="animal-view-tab-btn active" data-tab="historico">Histórico de Eventos</button>
                    <button class="animal-view-tab-btn" data-tab="producao-tab">Produção Leiteira</button>
                    <button class="animal-view-tab-btn" data-tab="lactacoes">Registros de Lactação</button>
                </div>
                <div id="historico" class="animal-view-tab-content active">
                    <ul class="timeline" id="animal-historico-timeline">
                        </ul>
                </div>
                <div id="producao-tab" class="animal-view-tab-content">
                    <h4 style="color:var(--secondary-color);">Gráfico de Produção Leiteira</h4>
                    <canvas id="animalProducaoChart" style="max-height: 300px;"></canvas>
                    <h4 style="margin-top: 15px; color:var(--secondary-color);">Registros de Produção (Últimos 15)</h4>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr><th>Data</th><th>Período</th><th>Litros</th><th>Ações</th></tr>
                            </thead>
                            <tbody id="animal-producao-list">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div id="lactacoes" class="animal-view-tab-content">
                    <h4 style="color:var(--secondary-color);">Registros de Lactação</h4>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr><th>Início</th><th>Fim (Secagem)</th><th>Parto Relacionado</th><th>Total (L)</th><th>Ações</th></tr>
                            </thead>
                            <tbody id="animal-lactacoes-list">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-importar-csv" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="document.getElementById('modal-importar-csv').style.display='none'">&times;</span>
                <h3 style="color:var(--secondary-color);">Importar Animais de Arquivo CSV</h3>
                <p>O arquivo CSV deve ter as seguintes colunas (na ordem): ID, Nome, Raça, Categoria, Peso, DataNasc, DataAquisicao, StatusReprodutivo, DataUltimoParto, DataSecagem, DataPrevisaoParto. Colunas vazias são permitidas.</p>
                <div class="form-group">
                    <label for="input-importar-csv">Selecionar Arquivo CSV:</label>
                    <input type="file" id="input-importar-csv" accept=".csv" required>
                </div>
                <button class="btn btn-primary" id="btn-importar-csv" disabled><i class="ph ph-file-csv"></i> Importar Animais</button>
            </div>
        </div>
        
        <div id="modal-relatorios-pdf" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="modal-close" onclick="document.getElementById('modal-relatorios-pdf').style.display='none'">&times;</span>
                <h3 style="color:var(--primary-color);">Gerar Relatório PDF</h3>
                
                <form id="form-relatorio-pdf">
                    <div class="form-group">
                        <label for="tipo-relatorio-select">Tipo de Relatório:</label>
                        <select id="tipo-relatorio-select" required onchange="toggleRelatorioFilters()">
                            <option value="">Selecione o Tipo...</option>
                            <option value="rebanho-geral">Rebanho Geral</option>
                            <option value="lactacao">Rebanho em Lactação</option>
                            <option value="tarefas-pendentes">Tarefas Pendentes</option>
                            <option value="tarefas-realizadas">Tarefas Realizadas</option>
                        </select>
                    </div>

                    <div id="filtros-animais" style="display: none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;">
                        <h4>Filtros de Animais</h4>
                        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="filtro-animal-raca">Raça (Palavra-chave):</label>
                                <input type="text" id="filtro-animal-raca" placeholder="Ex: Jersey, Holandesa">
                            </div>
                            <div class="form-group">
                                <label for="filtro-animal-categoria">Categoria:</label>
                                <select id="filtro-animal-categoria">
                                    <option value="">Todas</option>
                                    <option value="Vaca">Vaca</option>
                                    <option value="Novilha">Novilha</option>
                                    <option value="Bezerro(a)">Bezerro(a)</option>
                                    <option value="Boi">Boi</option>
                                </select>
                            </div>
                        </div>
                        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="filtro-animal-idade-min">Idade Mínima (meses):</label>
                                <input type="number" id="filtro-animal-idade-min" min="0" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label for="filtro-animal-idade-max">Idade Máxima (meses):</label>
                                <input type="number" id="filtro-animal-idade-max" min="0" placeholder="36">
                            </div>
                        </div>
                    </div>

                    <div id="filtros-lactacao" style="display: none; padding-top: 10px; margin-top: 10px; border-top: 1px dashed #eee;">
                        <h4 style="color:var(--info-color);">Filtros Específicos de Lactação</h4>
                         <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="filtro-lactacao-dias-min">Dias em Leite (Mín):</label>
                                <input type="number" id="filtro-lactacao-dias-min" min="0" placeholder="5">
                            </div>
                            <div class="form-group">
                                <label for="filtro-lactacao-dias-max">Dias em Leite (Máx):</label>
                                <input type="number" id="filtro-lactacao-dias-max" min="0" placeholder="305">
                            </div>
                        </div>
                         <div class="form-group">
                            <label for="filtro-lactacao-numero">Número de Lactação:</label>
                            <input type="number" id="filtro-lactacao-numero" min="1" placeholder="Ex: 1, 2, 3">
                        </div>
                    </div>

                    <div id="filtros-tarefas" style="display: none; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px;">
                        <h4>Filtros de Tarefas</h4>
                        <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group">
                                <label for="filtro-tarefa-data-inicio">Data Início (Prev./Realiz.):</label>
                                <input type="date" id="filtro-tarefa-data-inicio">
                            </div>
                            <div class="form-group">
                                <label for="filtro-tarefa-data-fim">Data Fim (Prev./Realiz.):</label>
                                <input type="date" id="filtro-tarefa-data-fim">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="filtro-tarefa-tipo">Tipo de Tarefa/Evento:</label>
                            <select id="filtro-tarefa-tipo">
                                <option value="">Todos os Tipos</option>
                                <option value="vacina">Vacinação</option>
                                <option value="vermifugo">Vermifugação</option>
                                <option value="cio">Previsão de Cio</option>
                                <option value="parto">Previsão de Parto</option>
                                <option value="cobertura">Cobertura/Inseminação</option>
                                <option value="diagnostico">Diagnóstico de Gestação</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;"><i class="ph ph-file-pdf"></i> Gerar Relatório</button>
                </form>
            </div>
        </div>

        </div> <script>
        // Configurações globais e funções utilitárias
        const APP_VERSION = "v8.0";
        const STORAGE_KEY = `rebanho-data-${APP_VERSION}`;
        const PLACEHOLDER_FOTO = "https://placehold.co/250x250/28a745/ffffff?text=Sem+Foto";

        // Variáveis de Estado
        let rebanhoData = {
            animais: [],
            producaoLeite: [],
            tarefas: [],
            lactacoes: [],
            nextAnimalId: 1
        };

        let producaoDiariaChart;
        let distribuicaoRebanhoChart;
        let animalProducaoChart;

        // Variáveis de Câmera
        let videoStream = null;

        // --- Mapeamento DOM (Atualizado com novos elementos de Relatório) ---
        const DOM = {
            // Navegação
            navLinks: document.querySelectorAll('.nav-link'),
            pageSections: document.querySelectorAll('.page-section'),

            // Dashboard
            totalAnimais: document.getElementById('total-animais'),
            vacasLactacao: document.getElementById('vacas-lactacao'),
            tarefasPendentes: document.getElementById('tarefas-pendentes'),
            producaoMediaDiaria: document.getElementById('producao-media-diaria'),
            proximasTarefasLista: document.getElementById('proximas-tarefas-lista'),
            proximosPartosLista: document.getElementById('proximos-partos-lista'),
            proximosCioLista: document.getElementById('proximos-cio-lista'),
            producaoDiariaChartCanvas: document.getElementById('producaoDiariaChart'),
            distribuicaoRebanhoChartCanvas: document.getElementById('distribuicaoRebanhoChart'),

            // Animais Section
            btnNovoAnimal: document.getElementById('btn-novo-animal'),
            filtroCategoriaSelect: document.getElementById('filtro-categoria'),
            buscaAnimalInput: document.getElementById('busca-animal'),
            animalListTbody: document.getElementById('animal-list-tbody'),

            // Modal Animal Form
            modalAnimalForm: document.getElementById('modal-animal-form'),
            parentPaiSelect: document.getElementById('parent-pai-select'),
            parentMaeSelect: document.getElementById('parent-mae-select'),
            animalSexoSelect: document.getElementById('animal-sexo-select'),
            animalForm: document.getElementById('animal-form'),
            animalIdInput: document.getElementById('animal-id'),
            animalNomeInput: document.getElementById('animal-nome'),
            animalRacaInput: document.getElementById('animal-raca'),
            animalCategoriaSelect: document.getElementById('animal-categoria-select'),
            animalPesoInput: document.getElementById('animal-peso'),
            animalDataNascInput: document.getElementById('animal-data-nasc'),
            animalDataAquisicaoInput: document.getElementById('animal-data-aquisicao'),
            vacaFields: document.getElementById('vaca-fields'),
            animalStatusReprodutivo: document.getElementById('animal-status-reprodutivo'),
            animalDataUltimoParto: document.getElementById('animal-data-ultimo-parto'),
            animalDataSecagem: document.getElementById('animal-data-secagem'),
            animalDataPrevisaoParto: document.getElementById('animal-data-previsao-parto'),
            animalFotoInput: document.getElementById('animal-foto-input'),
            fotoPreview: document.getElementById('foto-preview'),

            // Câmera
            cameraVideo: document.getElementById('camera-video'),
            cameraCanvas: document.getElementById('camera-canvas'),
            btnTirarFoto: document.getElementById('btn-tirar-foto'),
            btnCancelarCamera: document.getElementById('btn-cancelar-camera'),

            // Produção Leite
            leiteForm: document.getElementById('leite-form'),
            leiteDataInput: document.getElementById('leite-data-input'),
            leitePeriodoSelect: document.getElementById('leite-periodo-select'),
            leiteVacaSelect: document.getElementById('leite-vaca-select'),
            leiteQuantidadeInput: document.getElementById('leite-quantidade-input'),
            leiteListTbody: document.getElementById('leite-list-tbody'),

            // Tarefas (Saúde/Reprodução)
            tarefaForm: document.getElementById('tarefa-form'),
            tarefaAnimalSelect: document.getElementById('tarefa-animal-select'),
            tarefaTipoSelect: document.getElementById('tarefa-tipo-select'),
            tarefaData: document.getElementById('tarefa-data'),
            tarefaDescricao: document.getElementById('tarefa-descricao'),
            tarefaListTbody: document.getElementById('tarefa-list-tbody'),

            // Modal Animal View
            modalAnimalView: document.getElementById('modal-animal-view'),
            viewAnimalTitle: document.getElementById('view-animal-title'),
            viewAnimalFoto: document.getElementById('view-animal-foto'),
            viewAnimalDetails: document.getElementById('view-animal-details'),
            btnEditView: document.getElementById('btn-edit-view'),
            btnDeleteView: document.getElementById('btn-delete-view'),

            // Tabs de Visualização do Animal
            animalViewTabsContainer: document.getElementById('animal-view-tabs'),
            animalHistoricoTimeline: document.getElementById('animal-historico-timeline'),
            animalProducaoChartCanvas: document.getElementById('animalProducaoChart'),
            animalProducaoList: document.getElementById('animal-producao-list'),
            animalLactacoesList: document.getElementById('animal-lactacoes-list'),

            // Configurações
            resetDataBtn: document.getElementById('reset-data-btn'),
            btnExportarJson: document.getElementById('btn-exportar-json'),
            btnExportarCsv: document.getElementById('btn-exportar-csv'),
            // Removido btnGerarRelatorioPdf, usando o novo
            idPrefixForm: document.getElementById('id-prefix-form'),
            idPrefixInput: document.getElementById('id-prefix-input'),
            currentIdPrefix: document.getElementById('current-id-prefix'),
            inputImportarDados: document.getElementById('input-importar-dados'),
            btnImportarDados: document.getElementById('btn-importar-dados'),
            btnImportarDadosModal: document.getElementById('btn-importar-dados-modal'),

            // Modal Importar CSV
            modalImportarCsv: document.getElementById('modal-importar-csv'),
            btnImportarCsvModal: document.getElementById('btn-importar-csv-modal'),
            inputImportarCsv: document.getElementById('input-importar-csv'),
            btnImportarCsv: document.getElementById('btn-importar-csv'),
            
            // NOVO: Elementos do Modal de Relatórios PDF
            btnAbrirModalRelatorio: document.getElementById('btn-abrir-modal-relatorio'), // NOVO
            modalRelatoriosPdf: document.getElementById('modal-relatorios-pdf'), // NOVO
            formRelatorioPdf: document.getElementById('form-relatorio-pdf'), // NOVO
            tipoRelatorioSelect: document.getElementById('tipo-relatorio-select'), // NOVO
            filtrosAnimais: document.getElementById('filtros-animais'), // NOVO
            filtroAnimalRaca: document.getElementById('filtro-animal-raca'), // NOVO
            filtroAnimalCategoria: document.getElementById('filtro-animal-categoria'), // NOVO
            filtroAnimalIdadeMin: document.getElementById('filtro-animal-idade-min'), // NOVO
            filtroAnimalIdadeMax: document.getElementById('filtro-animal-idade-max'), // NOVO
            filtrosLactacao: document.getElementById('filtros-lactacao'), // NOVO
            filtroLactacaoDiasMin: document.getElementById('filtro-lactacao-dias-min'), // NOVO
            filtroLactacaoDiasMax: document.getElementById('filtro-lactacao-dias-max'), // NOVO
            filtroLactacaoNumero: document.getElementById('filtro-lactacao-numero'), // NOVO
            filtrosTarefas: document.getElementById('filtros-tarefas'), // NOVO
            filtroTarefaDataInicio: document.getElementById('filtro-tarefa-data-inicio'), // NOVO
            filtroTarefaDataFim: document.getElementById('filtro-tarefa-data-fim'), // NOVO
            filtroTarefaTipo: document.getElementById('filtro-tarefa-tipo'), // NOVO
        };

        // --- Funções de Utilitário ---

        // Função para formatar a data (NOVO/Atualizado)
        function formatDate(isoString) {
            if (!isoString) return 'N/D';
            try {
                // Adiciona T00:00:00 para tratar a data como UTC e evitar desvio de fuso horário
                const date = new Date(isoString + "T00:00:00"); 
                if (isNaN(date)) return 'N/D';
                return date.toLocaleDateString('pt-BR');
            } catch (e) {
                return 'N/D';
            }
        }

        // Função para calcular Idade em Meses (para a filtragem) (NOVO)
    function calculateAgeInMonths(dateOfBirth) {
    if (!dateOfBirth) return null;
    const birth = new Date(dateOfBirth + "T00:00:00"); // Assegura fuso horário
    const today = new Date();
    let ageMonths = (today.getFullYear() - birth.getFullYear()) * 12;
    ageMonths -= birth.getMonth();
    ageMonths += today.getMonth();
     //Se o dia atual for menor que o dia de nascimento, subtrai 1 mês
    if (today.getDate() < birth.getDate()) {
        ageMonths--;
    }
    return ageMonths > 0 ? ageMonths : 0;
}

       // Atualiza o select de categoria com base na data de nascimento e sexo do form
       function updateCategoryFromDobSex() {
           if (!DOM.animalDataNascInput || !DOM.animalSexoSelect || !DOM.animalCategoriaSelect) return;
           const dob = DOM.animalDataNascInput.value;
           const sexo = DOM.animalSexoSelect.value;
           const cat = classifyCategory(dob, sexo);
           if (cat) {
               // Preenche automaticamente (mas permite alteração manual)
               DOM.animalCategoriaSelect.value = cat;
               // Ajusta visibilidade de campos de vaca/novilha quando aplicável
               const isVacaOrNovilha = cat === 'Vaca' || cat === 'Novilha';
               DOM.vacaFields.style.display = isVacaOrNovilha ? 'block' : 'none';
           }
       }

        // Função para calcular Dias em Leite (DEL) (NOVO)
        function calculateDaysInMilk(lastCalvingDate) {
            if (!lastCalvingDate) return null;
            const today = new Date();
            const calving = new Date(lastCalvingDate + "T00:00:00"); // Assegura fuso horário
            if (calving > today) return 0; // Se a data do parto for futura, considera 0.
            const diffTime = Math.abs(today.getTime() - calving.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays;
        }

        // Função para formatar a idade (existente, mantida para exibir)
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 'N/D';
            const birth = new Date(dateOfBirth + "T00:00:00");
            const today = new Date();
            let ageYears = today.getFullYear() - birth.getFullYear();
            let ageMonths = today.getMonth() - birth.getMonth();

            if (ageMonths < 0 || (ageMonths === 0 && today.getDate() < birth.getDate())) {
                ageYears--;
                ageMonths += 12;
            }

            if (ageYears < 1) {
                return `${ageMonths} meses`;
            }
            return `${ageYears} anos e ${ageMonths} meses`;
        }

        // Função para formatar o ID
        function formatAnimalId(id) {
            const prefix = localStorage.getItem('idPrefix') || 'ID';
            return `${prefix}${String(id).padStart(4, '0')}`;
        }
        
        // Função para calcular próxima data de cio/parto
        function calculateNextReproDate(lastDate, type) { 
            if (!lastDate) return 'N/D';
            const date = new Date(lastDate + "T00:00:00"); 
            let daysToAdd = 0;
            if (type === 'parto') {
                // Previsão de parto (Ex: 285 dias após a última cobertura/inseminação)
                daysToAdd = 285; 
            } else if (type === 'cio') {
                // Previsão de cio (Ex: 21 dias após o último cio/parto)
                daysToAdd = 21; 
            } else {
                return 'N/D';
            }

            date.setDate(date.getDate() + daysToAdd);
            return formatDate(date.toISOString().split('T')[0]);
        }
        
        // Função para obter o nome do animal
        function getAnimalName(id) {
            const animal = rebanhoData.animais.find(a => a.id === id);
            return animal ? animal.nome : 'Animal Desconhecido';
        }

        // --- Funções do Novo Relatório PDF ---

        // Função para coletar os filtros do modal (NOVO)
        function collectRelatorioFilters(tipo) {
            const filtros = {};

            if (tipo === 'rebanho-geral' || tipo === 'lactacao') {
                // Filtros de Animais
                if (DOM.filtroAnimalRaca.value) filtros.raca = DOM.filtroAnimalRaca.value.trim();
                if (DOM.filtroAnimalCategoria.value) filtros.categoria = DOM.filtroAnimalCategoria.value;
                if (DOM.filtroAnimalIdadeMin.value) filtros.idadeMinMeses = parseInt(DOM.filtroAnimalIdadeMin.value);
                if (DOM.filtroAnimalIdadeMax.value) filtros.idadeMaxMeses = parseInt(DOM.filtroAnimalIdadeMax.value);
                
                // Filtros de Lactação (apenas se for 'lactacao')
                if (tipo === 'lactacao') {
                    if (DOM.filtroLactacaoDiasMin.value) filtros.diasLactacaoMin = parseInt(DOM.filtroLactacaoDiasMin.value);
                    if (DOM.filtroLactacaoDiasMax.value) filtros.diasLactacaoMax = parseInt(DOM.filtroLactacaoDiasMax.value);
                    if (DOM.filtroLactacaoNumero.value) filtros.numeroLactacao = parseInt(DOM.filtroLactacaoNumero.value);
                }
            } else if (tipo.startsWith('tarefas')) {
                // Filtros de Tarefas
                filtros.status = tipo === 'tarefas-pendentes' ? 'Pendente' : 'Realizada';
                if (DOM.filtroTarefaDataInicio.value) filtros.dataInicio = DOM.filtroTarefaDataInicio.value;
                if (DOM.filtroTarefaDataFim.value) filtros.dataFim = DOM.filtroTarefaDataFim.value;
                if (DOM.filtroTarefaTipo.value) filtros.tipo = DOM.filtroTarefaTipo.value;
            }

            return filtros;
        }

        // Função para mostrar/esconder filtros (NOVO)
        function toggleRelatorioFilters() {
            const tipo = DOM.tipoRelatorioSelect.value;
            
            // Esconder todos por padrão
            DOM.filtrosAnimais.style.display = 'none';
            DOM.filtrosLactacao.style.display = 'none';
            DOM.filtrosTarefas.style.display = 'none';

            if (tipo === 'rebanho-geral') {
                DOM.filtrosAnimais.style.display = 'grid';
            } else if (tipo === 'lactacao') {
                DOM.filtrosAnimais.style.display = 'grid';
                DOM.filtrosLactacao.style.display = 'block';
            } else if (tipo.startsWith('tarefas')) {
                DOM.filtrosTarefas.style.display = 'block';
            }
        }

        // Substitui a função generateReportPdf existente (Lógica principal de filtros)
        async function generateReportPdf(tipoRelatorio, filtros = {}) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageHeight = doc.internal.pageSize.height;
            let y = 10;
            const margin = 15;

            if (!tipoRelatorio) {
                showCustomAlert('Erro', 'Tipo de relatório inválido.', 'warning');
                return;
            }

            // Cabeçalho Padrão
            doc.setFontSize(18);
            doc.setTextColor(40, 167, 69); // Cor primária
            doc.text('Relatório Gerencial de Rebanho Leiteiro', margin, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125); // Cor cinza
            doc.text(`Data de Geração: ${formatDate(new Date().toISOString().split('T')[0])}`, margin, y);
            y += 5;
            
            doc.setDrawColor(40, 167, 69);
            doc.line(margin, y, 210 - margin, y); // Linha separadora
            y += 5;

            doc.setTextColor(52, 58, 64); // Cor texto principal

            let titulo, colunas, dados, subfiltros = 'Nenhum filtro aplicado.';
            let totalRegistros = 0;

            // --- Lógica de Filtragem ---
            
            if (tipoRelatorio === 'rebanho-geral') {
                titulo = 'Rebanho Geral';
                colunas = ['ID', 'Nome', 'Raça', 'Categoria', 'Idade', 'Status Reprodutivo'];
                
                const animaisFiltrados = rebanhoData.animais.filter(animal => {
                    const idadeMeses = calculateAgeInMonths(animal.dataNasc);
                    const racaMatch = filtros.raca ? animal.raca.toLowerCase().includes(filtros.raca.toLowerCase()) : true;
                    const categoriaMatch = filtros.categoria ? animal.categoria === filtros.categoria : true;
                    const idadeMinMatch = filtros.idadeMinMeses !== undefined ? idadeMeses >= filtros.idadeMinMeses : true;
                    const idadeMaxMatch = filtros.idadeMaxMeses !== undefined ? idadeMeses <= filtros.idadeMaxMeses : true;
                    
                    return racaMatch && categoriaMatch && idadeMinMatch && idadeMaxMatch;
                });

                dados = animaisFiltrados.map(animal => [
                    formatAnimalId(animal.id),
                    animal.nome,
                    animal.raca,
                    animal.categoria,
                    calculateAge(animal.dataNasc),
                    animal.statusReprodutivo || 'N/D'
                ]);

                // Resumo dos Filtros Aplicados
                const idadeFiltro = (filtros.idadeMinMeses !== undefined || filtros.idadeMaxMeses !== undefined) ? 
                    `${filtros.idadeMinMeses !== undefined ? filtros.idadeMinMeses + 'm' : '0m'} - ${filtros.idadeMaxMeses !== undefined ? filtros.idadeMaxMeses + 'm' : 'Máx'}` : 'Todas';
                
                subfiltros = `Filtros: Cat.: ${filtros.categoria || 'Todas'}, Raça: ${filtros.raca || 'Todas'}, Idade: ${idadeFiltro}`;

            } else if (tipoRelatorio === 'lactacao') {
                titulo = 'Rebanho em Lactação';
                colunas = ['ID', 'Nome', 'Raça', 'Nº Lactação', 'Último Parto', 'DEL'];

                const animaisFiltrados = rebanhoData.animais.filter(animal => {
                    if (animal.statusReprodutivo !== 'Em Lactação' || !animal.dataUltimoParto) return false;

                    const racaMatch = filtros.raca ? animal.raca.toLowerCase().includes(filtros.raca.toLowerCase()) : true;
                    const categoriaMatch = filtros.categoria ? animal.categoria === filtros.categoria : true;
                    
                    const diasLactacao = calculateDaysInMilk(animal.dataUltimoParto);
                    const idadeMeses = calculateAgeInMonths(animal.dataNasc);

                    const idadeMinMatch = filtros.idadeMinMeses !== undefined ? idadeMeses >= filtros.idadeMinMeses : true;
                    const idadeMaxMatch = filtros.idadeMaxMeses !== undefined ? idadeMeses <= filtros.idadeMaxMeses : true;
                    
                    const diasMinMatch = filtros.diasLactacaoMin !== undefined ? diasLactacao >= filtros.diasLactacaoMin : true;
                    const diasMaxMatch = filtros.diasLactacaoMax !== undefined ? diasLactacao <= filtros.diasLactacaoMax : true;
                    // Assumindo que lactacoes é um array no animal, o número de lactação é o seu length
                    const numLactacaoAtual = animal.lactacoes ? animal.lactacoes.length : 0; 
                    const numeroLactacaoMatch = filtros.numeroLactacao !== undefined ? numLactacaoAtual === filtros.numeroLactacao : true; 
                    
                    return racaMatch && categoriaMatch && idadeMinMatch && idadeMaxMatch && diasMinMatch && diasMaxMatch && numeroLactacaoMatch;
                });
                
                dados = animaisFiltrados.map(animal => {
                    const diasLactacao = calculateDaysInMilk(animal.dataUltimoParto) || 'N/D';
                    const numLactacao = animal.lactacoes ? animal.lactacoes.length : 'N/D'; 
                    return [
                        formatAnimalId(animal.id),
                        animal.nome,
                        animal.raca,
                        numLactacao,
                        formatDate(animal.dataUltimoParto),
                        `${diasLactacao} dias`
                    ];
                });

                // Resumo dos Filtros Aplicados
                const diasFiltro = (filtros.diasLactacaoMin !== undefined || filtros.diasLactacaoMax !== undefined) ? 
                    `${filtros.diasLactacaoMin !== undefined ? filtros.diasLactacaoMin : '0'} - ${filtros.diasLactacaoMax !== undefined ? filtros.diasLactacaoMax : 'Máx'} dias` : 'Todos';

                subfiltros = `Filtros: Raça: ${filtros.raca || 'Todas'}, DEL: ${diasFiltro}, Nº Lactação: ${filtros.numeroLactacao || 'Todos'}`;

            } else if (tipoRelatorio.startsWith('tarefas')) {
                const isPendente = tipoRelatorio === 'tarefas-pendentes';
                titulo = isPendente ? 'Tarefas Pendentes' : 'Tarefas Realizadas';
                colunas = ['Data (Prev./Real.)', 'Animal', 'Tipo', 'Detalhes'];
                
                // Filtro de tarefas: Assumimos que a tarefa tem um campo 'done: boolean'
                const tarefasFiltradas = rebanhoData.tarefas.filter(tarefa => {
                    // Filtro por Status
                    const statusMatch = isPendente ? !tarefa.done : tarefa.done;
                    if (!statusMatch) return false;

                    // Filtro por Tipo
                    const tipoMatch = filtros.tipo ? tarefa.tipo === filtros.tipo : true;

                    // Filtro por Data: usa data limite (tarefa.data) para Pendentes, e dataConclusao (se existir) para Realizadas
                    const dataReferencia = isPendente ? tarefa.data : (tarefa.dataConclusao || tarefa.data);
                    const dataInicioMatch = filtros.dataInicio ? dataReferencia >= filtros.dataInicio : true;
                    const dataFimMatch = filtros.dataFim ? dataReferencia <= filtros.dataFim : true;
                    
                    return tipoMatch && dataInicioMatch && dataFimMatch;
                });

                // Montar dados para a tabela
                dados = tarefasFiltradas.map(tarefa => {
                    const animal = rebanhoData.animais.find(a => a.id === tarefa.animalId) || { nome: 'Animal Removido' };
                    const dataFinal = isPendente ? formatDate(tarefa.data) : (tarefa.dataConclusao ? formatDate(tarefa.dataConclusao) : formatDate(tarefa.data));
                    return [
                        dataFinal,
                        animal.nome,
                        tarefa.tipo.charAt(0).toUpperCase() + tarefa.tipo.slice(1), 
                        tarefa.descricao
                    ];
                });

                // Resumo dos Filtros Aplicados
                const dataFiltro = filtros.dataInicio || filtros.dataFim ?
                    `${formatDate(filtros.dataInicio) || 'Início'} a ${formatDate(filtros.dataFim) || 'Fim'}` : 'Todas';

                subfiltros = `Filtros: Tipo: ${filtros.tipo || 'Todos'}, Período: ${dataFiltro}`;
            }

            totalRegistros = dados.length;
            
            // Alerta se não houver registros
            if (totalRegistros === 0) {
                showCustomAlert('Atenção', `Nenhum registro encontrado para o relatório de ${titulo} com os filtros aplicados.`, 'warning');
                return;
            }

            doc.setFontSize(14);
            doc.text(`${titulo} (${totalRegistros} registros)`, margin, y);
            y += 7;
            
            // Adicionar linha de subfiltros
            doc.setFontSize(10);
            doc.text(subfiltros, margin, y);
            y += 5;

            // Configuração e Geração da Tabela
            doc.autoTable({
                startY: y,
                head: [colunas],
                body: dados,
                theme: 'striped',
                headStyles: { 
                    fillColor: [0, 123, 255], // Azul secundário
                    textColor: 255, 
                    fontStyle: 'bold' 
                }, 
                styles: { 
                    fontSize: 9, 
                    cellPadding: 3 
                },
                didDrawPage: function(data) {
                    // Rodapé com número de página
                    doc.setFontSize(10);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), 
                        data.settings.margin.left, 
                        pageHeight - 10
                    );
                }
            });

            // Salvar o PDF
            doc.save(`Relatorio_${tipoRelatorio}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ... (Restante do código JavaScript deve ser colado aqui, substituindo o original)

        // --- Funções Auxiliares de UI/Lógica de Negócios (Existentes) ---

        // Função para mostrar/esconder seções da página
        function showSection(sectionId) {
            DOM.pageSections.forEach(section => {
                section.style.display = 'none';
                if (section.id === sectionId) {
                    section.style.display = 'block';
                }
            });
            DOM.navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });
            updateDashboard(); // Garante que o dashboard é atualizado ao retornar
            if (sectionId === 'animais') {
                renderAnimalList();
            }
        }

        // Função para persistir dados no LocalStorage
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(rebanhoData));
            } catch (error) {
                console.error("Erro ao salvar dados no LocalStorage:", error);
                showCustomAlert('Erro de Dados', 'Não foi possível salvar os dados. Verifique o espaço de armazenamento do navegador.', 'danger');
            }
        }

        // Função para carregar dados do LocalStorage
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    rebanhoData = JSON.parse(data);
                    // Garante que os arrays estejam inicializados se o load falhar
                    rebanhoData.animais = rebanhoData.animais || [];
                    rebanhoData.producaoLeite = rebanhoData.producaoLeite || [];
                    rebanhoData.tarefas = rebanhoData.tarefas || [];
                    rebanhoData.lactacoes = rebanhoData.lactacoes || [];
                    rebanhoData.nextAnimalId = rebanhoData.nextAnimalId || 1;
                } catch (error) {
                    console.error("Erro ao parsear dados do LocalStorage:", error);
                    showCustomAlert('Erro de Leitura', 'Os dados salvos estão corrompidos. Carregando dados vazios.', 'danger');
                }
            }
            // Atualiza o prefixo de ID na interface
            DOM.currentIdPrefix.textContent = localStorage.getItem('idPrefix') || 'ID';
        }

        // Função de Alerta Personalizado (Melhorada para funcionar globalmente)
        let currentAlert = null;
        function showCustomAlert(title, message, type = 'info') {
            if (currentAlert) return; 

            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay show';
            overlay.style.display = 'flex';
            currentAlert = overlay;

            const iconMap = {
                'success': 'ph-check-circle',
                'danger': 'ph-x-circle',
                'warning': 'ph-warning-octagon',
                'info': 'ph-info'
            };

            overlay.innerHTML = `
                <div class="custom-alert-box ${type}">
                    <i class="ph ${iconMap[type] || 'ph-info'} custom-alert-icon" style="color:var(--${type}-color);"></i>
                    <h3>${title}</h3>
                    <p class="custom-alert-message">${message}</p>
                    <div class="custom-alert-actions">
                        <button class="btn btn-primary" onclick="closeCustomAlert()"><i class="ph ph-check"></i> OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function closeCustomAlert() {
            if (currentAlert) {
                currentAlert.classList.remove('show');
                currentAlert.querySelector('.custom-alert-box').style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (currentAlert && currentAlert.parentNode) {
                        currentAlert.parentNode.removeChild(currentAlert);
                    }
                    currentAlert = null;
                }, 300);
            }
        }
        
        // Função de Confirmação Personalizada
        function showCustomConfirm(title, message, onConfirm, onCancel = () => {}) {
            if (currentAlert) return; 

            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay show';
            overlay.style.display = 'flex';
            currentAlert = overlay;

            overlay.innerHTML = `
                <div class="custom-alert-box confirm">
                    <i class="ph ph-warning-octagon custom-alert-icon" style="color:var(--warning-color);"></i>
                    <h3>${title}</h3>
                    <p class="custom-alert-message">${message}</p>
                    <div class="custom-alert-actions">
                        <button class="btn btn-danger" id="confirm-yes"><i class="ph ph-check"></i> Confirmar</button>
                        <button class="btn btn-secondary" id="confirm-no"><i class="ph ph-x"></i> Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            document.getElementById('confirm-yes').onclick = () => {
                closeCustomAlert();
                onConfirm();
            };
            document.getElementById('confirm-no').onclick = () => {
                closeCustomAlert();
                onCancel();
            };
        }

        // --- Funções de Manipulação de Dados (CRUD) ---

        // Função para criar/editar animal
        function saveAnimal(event) {
            event.preventDefault();

            const isEditing = DOM.animalIdInput.value !== '';
            const animalId = isEditing ? parseInt(DOM.animalIdInput.value) : rebanhoData.nextAnimalId;

            const newAnimal = {
                id: animalId,
                nome: DOM.animalNomeInput.value,
                raca: DOM.animalRacaInput.value,
                sexo: DOM.animalSexoSelect.value || 'Indefinido',
                categoria: DOM.animalCategoriaSelect.value,
                peso: parseFloat(DOM.animalPesoInput.value),
                dataNasc: DOM.animalDataNascInput.value,
                dataAquisicao: DOM.animalDataAquisicaoInput.value,
                statusReprodutivo: DOM.animalStatusReprodutivo.value,
                dataUltimoParto: DOM.animalDataUltimoParto.value || null,
                dataSecagem: DOM.animalDataSecagem.value || null,
                dataPrevisaoParto: DOM.animalDataPrevisaoParto.value || null,
                fotoBase64: DOM.fotoPreview.src === PLACEHOLDER_FOTO ? null : DOM.fotoPreview.src,
                parentPaiId: DOM.parentPaiSelect.value ? parseInt(DOM.parentPaiSelect.value) : null,
                parentMaeId: DOM.parentMaeSelect.value ? parseInt(DOM.parentMaeSelect.value) : null,
                lactacoes: rebanhoData.animais.find(a => a.id === animalId)?.lactacoes || [], // Mantém lactações existentes
            };

            if (isEditing) {
                const index = rebanhoData.animais.findIndex(a => a.id === animalId);
                if (index > -1) {
                    // Preserva os dados que não estão no formulário de edição (ex: foto se não foi alterada)
                    newAnimal.fotoBase64 = newAnimal.fotoBase64 || rebanhoData.animais[index].fotoBase64;

                    if (!DOM.animalSexoSelect.value) newAnimal.sexo = rebanhoData.animais[index].sexo || 'Indefinido';
                    if (!DOM.parentPaiSelect.value) newAnimal.parentPaiId = rebanhoData.animais[index].parentPaiId || null;
                    if (!DOM.parentMaeSelect.value) newAnimal.parentMaeId = rebanhoData.animais[index].parentMaeId || null;
                    rebanhoData.animais[index] = newAnimal;
                }
                showCustomAlert('Sucesso', `Animal ${formatAnimalId(animalId)} atualizado com sucesso!`, 'success');
            } else {
                rebanhoData.animais.push(newAnimal);
                rebanhoData.nextAnimalId++;
                showCustomAlert('Sucesso', `Novo animal ${formatAnimalId(animalId)} cadastrado!`, 'success');
            }

            DOM.modalAnimalForm.style.display = 'none';
            saveData();
            renderAnimalList();
            updateAllSelectors();
            updateDashboard();
        }

        // Função para abrir o formulário (Edição ou Novo)
        function openAnimalForm(animalId = null) {
            DOM.animalForm.reset();
            DOM.animalIdInput.value = '';
            DOM.fotoPreview.src = PLACEHOLDER_FOTO;
            DOM.fotoPreview.style.display = 'none';
            DOM.vacaFields.style.display = 'none';
            
            // Listener temporário para mostrar/esconder campos de Vaca/Novilha
            DOM.animalCategoriaSelect.onchange = () => {
                const isVacaOrNovilha = DOM.animalCategoriaSelect.value === 'Vaca' || DOM.animalCategoriaSelect.value === 'Novilha';
                DOM.vacaFields.style.display = isVacaOrNovilha ? 'block' : 'none';
                if (!isVacaOrNovilha) {
                    // Limpar campos se a categoria mudar
                    DOM.animalStatusReprodutivo.value = 'Vazia';
                    DOM.animalDataUltimoParto.value = '';
                    DOM.animalDataSecagem.value = '';
                    DOM.animalDataPrevisaoParto.value = '';
                }
            };
            
            if (animalId) {
                const animal = rebanhoData.animais.find(a => a.id === animalId);
                if (animal) {
                    populateParentSelects(animal.id);

                    DOM.animalIdInput.value = animal.id;
                    DOM.animalNomeInput.value = animal.nome;
                    DOM.animalRacaInput.value = animal.raca;
                     DOM.animalSexoSelect.value = animal.sexo || '';
                    DOM.animalCategoriaSelect.value = animal.categoria;
                    DOM.animalPesoInput.value = animal.peso;
                    DOM.animalDataNascInput.value = animal.dataNasc;
                    DOM.animalDataAquisicaoInput.value = animal.dataAquisicao;
                    DOM.parentPaiSelect.value = animal.parentPaiId || '';
                    DOM.parentMaeSelect.value = animal.parentMaeId || '';

                    const isVacaOrNovilha = animal.categoria === 'Vaca' || animal.categoria === 'Novilha';
                    DOM.vacaFields.style.display = isVacaOrNovilha ? 'block' : 'none';

                    if (isVacaOrNovilha) {
                        DOM.animalStatusReprodutivo.value = animal.statusReprodutivo || 'Vazia';
                        DOM.animalDataUltimoParto.value = animal.dataUltimoParto || '';
                        DOM.animalDataSecagem.value = animal.dataSecagem || '';
                        DOM.animalDataPrevisaoParto.value = animal.dataPrevisaoParto || '';
                    }
                    
                    if (animal.fotoBase64) {
                        DOM.fotoPreview.src = animal.fotoBase64;
                        DOM.fotoPreview.style.display = 'block';
                    } else {
                         DOM.fotoPreview.src = PLACEHOLDER_FOTO;
                         DOM.fotoPreview.style.display = 'none';
                    }

                    document.querySelector('#modal-animal-form h3').textContent = `Editar Animal ${formatAnimalId(animal.id)}`;
                }
            } else {
                document.querySelector('#modal-animal-form h3').textContent = `Novo Animal (Próximo ID: ${formatAnimalId(rebanhoData.nextAnimalId)})`;
                DOM.animalCategoriaSelect.value = ''; // Reset para a opção "Selecione..."
                DOM.animalStatusReprodutivo.value = 'Vazia';
                populateParentSelects();
                DOM.animalSexoSelect.value = '';
                DOM.parentPaiSelect.value = '';
                DOM.parentMaeSelect.value = '';
            }

            DOM.modalAnimalForm.style.display = 'flex';
            DOM.modalAnimalView.style.display = 'none'; // Fechar modal de visualização se estiver aberto
        }

        // Função para exclusão de animal
        function deleteAnimal(animalId) {
            showCustomConfirm('Confirmar Exclusão', `Tem certeza que deseja excluir o animal ${formatAnimalId(animalId)} e todos os seus registros de leite/tarefas? Esta ação é irreversível.`, () => {
                rebanhoData.animais = rebanhoData.animais.filter(a => a.id !== animalId);
                rebanhoData.producaoLeite = rebanhoData.producaoLeite.filter(p => p.animalId !== animalId);
                rebanhoData.tarefas = rebanhoData.tarefas.filter(t => t.animalId !== animalId);
                rebanhoData.lactacoes = rebanhoData.lactacoes.filter(l => l.animalId !== animalId);

                saveData();
                DOM.modalAnimalView.style.display = 'none';
                renderAnimalList();
                updateDashboard();
                updateAllSelectors();
                showCustomAlert('Sucesso', `Animal ${formatAnimalId(animalId)} excluído.`, 'success');
            });
        }

        // --- Funções de Leite/Produção ---

        // Função para salvar registro de leite
        function saveLeite(event) {
            event.preventDefault();
            
            const animalId = parseInt(DOM.leiteVacaSelect.value);
            const animal = rebanhoData.animais.find(a => a.id === animalId);

            if (!animal || animal.statusReprodutivo !== 'Em Lactação') {
                showCustomAlert('Erro', 'O animal selecionado não está em lactação.', 'warning');
                return;
            }

            const novoRegistro = {
                id: Date.now(), // ID simples baseado no timestamp
                animalId: animalId,
                data: DOM.leiteDataInput.value,
                periodo: DOM.leitePeriodoSelect.value,
                quantidade: parseFloat(DOM.leiteQuantidadeInput.value)
            };

            rebanhoData.producaoLeite.push(novoRegistro);
            rebanhoData.producaoLeite.sort((a, b) => new Date(b.data) - new Date(a.data)); // Ordena por data mais recente
            
            // Lógica de atualização da lactação do animal
            const lactacaoIndex = rebanhoData.lactacoes.findIndex(l => l.animalId === animalId && !l.dataFim);
            if (lactacaoIndex === -1) {
                // Se a vaca está em lactação mas não tem lactação aberta, abre uma nova
                rebanhoData.lactacoes.push({
                    id: Date.now() + 1,
                    animalId: animalId,
                    dataInicio: animal.dataUltimoParto || novoRegistro.data,
                    dataFim: null,
                    totalLitros: novoRegistro.quantidade
                });
            } else {
                rebanhoData.lactacoes[lactacaoIndex].totalLitros += novoRegistro.quantidade;
            }

            saveData();
            DOM.leiteForm.reset();
            populateVacaSelects(); // Mantém o select atualizado
            renderLeiteList();
            updateDashboard();
            showCustomAlert('Sucesso', 'Produção de leite registrada!', 'success');
        }

        // Função para deletar registro de leite
        function deleteLeiteRegistro(registroId) {
            showCustomConfirm('Confirmar Exclusão', 'Tem certeza que deseja excluir este registro de produção de leite? Isso afetará o total da lactação.', () => {
                const registro = rebanhoData.producaoLeite.find(r => r.id === registroId);
                if (registro) {
                    // Reverte a contagem de litros na lactação
                    const lactacaoIndex = rebanhoData.lactacoes.findIndex(l => l.animalId === registro.animalId && !l.dataFim);
                    if (lactacaoIndex !== -1) {
                        rebanhoData.lactacoes[lactacaoIndex].totalLitros -= registro.quantidade;
                        // Opcional: Remover lactação se o total cair a zero e não tiver data de fim
                        if (rebanhoData.lactacoes[lactacaoIndex].totalLitros <= 0) {
                             rebanhoData.lactacoes[lactacaoIndex].totalLitros = 0;
                        }
                    }
                    
                    rebanhoData.producaoLeite = rebanhoData.producaoLeite.filter(r => r.id !== registroId);
                    saveData();
                    renderLeiteList();
                    updateDashboard();
                    
                    // Se estiver no modal de visualização do animal, atualiza a lista interna
                    if (DOM.modalAnimalView.style.display === 'flex') {
                        const animalId = parseInt(DOM.btnEditView.dataset.animalId);
                        viewAnimal(animalId);
                    }
                    showCustomAlert('Sucesso', 'Registro de leite excluído.', 'success');
                }
            });
        }
        
        // Função para deletar registro de lactação (Usado no modal de visualização)
        function deleteLactacaoRegistro(lactacaoId, animalId) {
            showCustomConfirm('Confirmar Exclusão', 'Tem certeza que deseja excluir este registro COMPLETO de lactação? Todos os registros de produção de leite relacionados serão mantidos.', () => {
                // Apenas remove o registro da tabela de lactação. Os registros diários de leite permanecem no rebanhoData.producaoLeite.
                rebanhoData.lactacoes = rebanhoData.lactacoes.filter(l => l.id !== lactacaoId);
                saveData();
                viewAnimal(animalId); // Re-renderiza a visualização
                showCustomAlert('Sucesso', 'Registro de lactação excluído.', 'success');
            });
        }


        // --- Funções de Saúde/Tarefas ---

        // Função para salvar nova tarefa
        function saveTarefa(event) {
            event.preventDefault();

            const novaTarefa = {
                id: Date.now(),
                animalId: parseInt(DOM.tarefaAnimalSelect.value),
                tipo: DOM.tarefaTipoSelect.value,
                data: DOM.tarefaData.value, // Data limite ou previsão
                descricao: DOM.tarefaDescricao.value,
                done: false,
                dataConclusao: null,
            };

            rebanhoData.tarefas.push(novaTarefa);
            saveData();
            DOM.tarefaForm.reset();
            renderTarefaList();
            updateDashboard();
            showCustomAlert('Sucesso', 'Nova tarefa adicionada!', 'success');
        }

        // Função para marcar tarefa como realizada
        function markTarefaAsDone(tarefaId) {
            showCustomConfirm('Confirmar Tarefa', 'Marcar esta tarefa como realizada?', () => {
                const tarefa = rebanhoData.tarefas.find(t => t.id === tarefaId);
                if (tarefa) {
                    tarefa.done = true;
                    tarefa.dataConclusao = new Date().toISOString().split('T')[0];
                    saveData();
                    renderTarefaList();
                    updateDashboard();
                    showCustomAlert('Sucesso', 'Tarefa concluída!', 'success');
                    
                    // Lógica adicional para eventos reprodutivos
                    if (tarefa.tipo === 'parto') {
                        updateAnimalPostParto(tarefa.animalId, tarefa.dataConclusao);
                    } else if (tarefa.tipo === 'cobertura') {
                        updateAnimalPostCobertura(tarefa.animalId, tarefa.dataConclusao);
                    }
                }
            });
        }
        
        // Função para deletar tarefa
        function deleteTarefa(tarefaId) {
            showCustomConfirm('Confirmar Exclusão', 'Tem certeza que deseja excluir esta tarefa?', () => {
                rebanhoData.tarefas = rebanhoData.tarefas.filter(t => t.id !== tarefaId);
                saveData();
                renderTarefaList();
                updateDashboard();
                showCustomAlert('Sucesso', 'Tarefa excluída.', 'success');
            });
        }

        // Lógica de Negócios: Atualizar status do animal após o parto
        function updateAnimalPostParto(animalId, dataParto) {
            const animal = rebanhoData.animais.find(a => a.id === animalId);
            if (animal) {
                animal.statusReprodutivo = 'Em Lactação';
                animal.dataUltimoParto = dataParto;
                animal.dataPrevisaoParto = null; // Limpa previsão antiga
                
                // Abre uma nova lactação
                rebanhoData.lactacoes.push({
                    id: Date.now(),
                    animalId: animalId,
                    dataInicio: dataParto,
                    dataFim: null,
                    totalLitros: 0
                });

                // Cria tarefas futuras (Secagem, Próximo Cio)
                const dataSecagemPrevista = new Date(dataParto + "T00:00:00");
                dataSecagemPrevista.setDate(dataSecagemPrevista.getDate() + 305); // Exemplo: 305 dias
                
                rebanhoData.tarefas.push({
                    id: Date.now() + 1,
                    animalId: animalId,
                    tipo: 'secagem',
                    data: dataSecagemPrevista.toISOString().split('T')[0],
                    descricao: 'Previsão de Secagem (305 dias pós-parto).',
                    done: false,
                    dataConclusao: null,
                });
                
                rebanhoData.tarefas.push({
                    id: Date.now() + 2,
                    animalId: animalId,
                    tipo: 'cio',
                    data: calculateNextReproDate(dataParto, 'cio'),
                    descricao: 'Primeiro Cio pós-parto (aprox. 21 dias).',
                    done: false,
                    dataConclusao: null,
                });
                
                showCustomAlert('Ação Adicional', `Animal ${animal.nome} atualizado para 'Em Lactação'. Nova previsão de Secagem e Cio adicionadas.`, 'info');
                saveData();
            }
        }
        
        // Lógica de Negócios: Atualizar status do animal após a cobertura
        function updateAnimalPostCobertura(animalId, dataCobertura) {
            const animal = rebanhoData.animais.find(a => a.id === animalId);
            if (animal) {
                // Remove tarefas de cio pendentes
                rebanhoData.tarefas = rebanhoData.tarefas.filter(t => t.animalId !== animalId || t.tipo !== 'cio' || t.done);
                
                // Adiciona tarefa de Diagnóstico de Gestação
                const dataDiagnostico = new Date(dataCobertura + "T00:00:00");
                dataDiagnostico.setDate(dataDiagnostico.getDate() + 45); // Exemplo: 45 dias para diagnóstico
                
                rebanhoData.tarefas.push({
                    id: Date.now(),
                    animalId: animalId,
                    tipo: 'diagnostico',
                    data: dataDiagnostico.toISOString().split('T')[0],
                    descricao: 'Diagnóstico de gestação (45 dias pós-cobertura).',
                    done: false,
                    dataConclusao: null,
                });
                
                showCustomAlert('Ação Adicional', `Tarefa de Diagnóstico adicionada para ${animal.nome}.`, 'info');
                saveData();
            }
        }


        // --- Funções de Renderização e Atualização ---

        // Renderiza a lista de animais na seção "Animais"
        function renderAnimalList() {
            const tbody = DOM.animalListTbody;
            tbody.innerHTML = '';
            
            const filtroCat = DOM.filtroCategoriaSelect.value;
            const buscaTermo = DOM.buscaAnimalInput.value.toLowerCase();

            rebanhoData.animais.forEach(animal => {
                const animalIdFormatado = formatAnimalId(animal.id);
                const animalAge = calculateAge(animal.dataNasc);
                
                // Aplica filtros
                const categoriaMatch = !filtroCat || animal.categoria === filtroCat;
                const buscaMatch = !buscaTermo || 
                                   animalIdFormatado.toLowerCase().includes(buscaTermo) || 
                                   animal.nome.toLowerCase().includes(buscaTermo) ||
                                   animal.raca.toLowerCase().includes(buscaTermo);

                if (categoriaMatch && buscaMatch) {
                    const row = tbody.insertRow();
                    row.onclick = () => viewAnimal(animal.id);
                    const imgSrc = animal.fotoBase64 || PLACEHOLDER_FOTO;

                    row.innerHTML = `
                        <td>${animalIdFormatado}</td>
                       <td><img class="animal-thumb" src="${imgSrc}" alt="Foto ${animal.nome}"></td>
                        <td>${animal.nome}</td>
                        <td>${animal.sexo || 'N/D'}</td>
                        <td>${parentDisplay(animal.parentPaiId)} / ${parentDisplay(animal.parentMaeId)}</td>
                        <td>${animal.categoria}</td>
                        <td>${animalAge}</td>
                        <td>${animal.statusReprodutivo || 'N/D'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); openAnimalForm(${animal.id})"><i class="ph ph-pencil"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteAnimal(${animal.id})"><i class="ph ph-trash"></i></button>
                        </td>
                    `;
                }
            });
        }
        
        // Renderiza a lista de registros de leite na seção "Produção"
        function renderLeiteList() {
            const tbody = DOM.leiteListTbody;
            tbody.innerHTML = '';
            
            // Exibir apenas os últimos 50 registros
            const registrosParaExibir = rebanhoData.producaoLeite.slice(0, 50);

            registrosParaExibir.forEach(registro => {
                const animalName = getAnimalName(registro.animalId);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(registro.data)}</td>
                    <td>${animalName}</td>
                    <td>${registro.periodo.charAt(0).toUpperCase() + registro.periodo.slice(1)}</td>
                    <td>${registro.quantidade.toFixed(2)} L</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteLeiteRegistro(${registro.id})"><i class="ph ph-trash"></i></button>
                    </td>
                `;
            });
        }
        
        // Renderiza a lista de tarefas pendentes na seção "Saúde"
        function renderTarefaList() {
            const tbody = DOM.tarefaListTbody;
            tbody.innerHTML = '';
            
            // Filtra e ordena as tarefas pendentes
            const tarefasPendentes = rebanhoData.tarefas
                .filter(t => !t.done)
                .sort((a, b) => new Date(a.data) - new Date(b.data)); // Ordena pela data mais próxima

            tarefasPendentes.forEach(tarefa => {
                const animalName = getAnimalName(tarefa.animalId);
                const isLate = new Date(tarefa.data) < new Date().setHours(0,0,0,0);
                
                const row = tbody.insertRow();
                row.className = isLate ? 'table-danger' : ''; // Estilo para tarefas atrasadas
                row.innerHTML = `
                    <td>${formatDate(tarefa.data)}</td>
                    <td>${animalName}</td>
                    <td>${tarefa.tipo.charAt(0).toUpperCase() + tarefa.tipo.slice(1)}</td>
                    <td>${tarefa.descricao}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); markTarefaAsDone(${tarefa.id})"><i class="ph ph-check"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteTarefa(${tarefa.id})"><i class="ph ph-trash"></i></button>
                    </td>
                `;
            });
            
            // Atualiza a lista de tarefas no Dashboard
            renderProximasTarefas(tarefasPendentes.slice(0, 5));
        }
        
        // Renderiza a lista de tarefas no Dashboard
        function renderProximasTarefas(tarefas) {
            DOM.proximasTarefasLista.innerHTML = '';
            if (tarefas.length === 0) {
                 DOM.proximasTarefasLista.innerHTML = '<p class="text-secondary">Nenhuma tarefa pendente nas próximas semanas.</p>';
                 DOM.tarefasPendentes.textContent = 0;
                 DOM.tarefasPendentes.closest('.metric-card').classList.remove('warning');
                 DOM.tarefasPendentes.closest('.metric-card').classList.add('success');
                return;
            }
            
            tarefas.forEach(tarefa => {
                const animalName = getAnimalName(tarefa.animalId);
                const item = document.createElement('li');
                item.className = 'tarefa-item';
                item.innerHTML = `
                    <div class="tarefa-info">
                        <strong>${tarefa.tipo.charAt(0).toUpperCase() + tarefa.tipo.slice(1)} - ${animalName}</strong>
                        <span class="tarefa-meta">Data: ${formatDate(tarefa.data)}</span>
                    </div>
                    <div class="tarefa-actions">
                        <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); markTarefaAsDone(${tarefa.id})"><i class="ph ph-check"></i></button>
                    </div>
                `;
                DOM.proximasTarefasLista.appendChild(item);
            });
            
            // Atualiza o contador do dashboard
            const totalPendentes = rebanhoData.tarefas.filter(t => !t.done).length;
            DOM.tarefasPendentes.textContent = totalPendentes;
            DOM.tarefasPendentes.closest('.metric-card').classList.toggle('warning', totalPendentes > 0);
             DOM.tarefasPendentes.closest('.metric-card').classList.toggle('success', totalPendentes === 0);
        }

        // Renderiza as previsões de parto e cio no Dashboard
        function renderProximosEventosReprodutivos() {
            DOM.proximosPartosLista.innerHTML = '';
            DOM.proximosCioLista.innerHTML = '';

            const today = new Date().setHours(0,0,0,0);
            const limit30Days = new Date();
            limit30Days.setDate(limit30Days.getDate() + 30);

            // 1. Partos Previstos (baseado no campo animal.dataPrevisaoParto)
            const proximosPartos = rebanhoData.animais
                .filter(a => a.dataPrevisaoParto && new Date(a.dataPrevisaoParto) >= today && new Date(a.dataPrevisaoParto) <= limit30Days)
                .sort((a, b) => new Date(a.dataPrevisaoParto) - new Date(b.dataPrevisaoParto));
            
            if (proximosPartos.length === 0) {
                 DOM.proximosPartosLista.innerHTML = '<p class="text-secondary">Nenhum parto previsto nos próximos 30 dias.</p>';
            } else {
                 proximosPartos.forEach(animal => {
                    const item = document.createElement('li');
                    item.className = 'tarefa-item';
                    item.innerHTML = `
                        <div class="tarefa-info" onclick="viewAnimal(${animal.id})">
                            <strong>Parto de ${animal.nome} (${formatAnimalId(animal.id)})</strong>
                            <span class="tarefa-meta">Data Prevista: ${formatDate(animal.dataPrevisaoParto)}</span>
                        </div>
                    `;
                    DOM.proximosPartosLista.appendChild(item);
                });
            }

            // 2. Cios Previstos (baseado nas tarefas de cio)
            const proximosCios = rebanhoData.tarefas
                .filter(t => t.tipo === 'cio' && !t.done && new Date(t.data) >= today && new Date(t.data) <= limit30Days)
                .sort((a, b) => new Date(a.data) - new Date(b.data));

             if (proximosCios.length === 0) {
                 DOM.proximosCioLista.innerHTML = '<p class="text-secondary">Nenhum cio previsto nos próximos 30 dias (tarefas).</p>';
            } else {
                proximosCios.forEach(tarefa => {
                    const animalName = getAnimalName(tarefa.animalId);
                    const item = document.createElement('li');
                    item.className = 'tarefa-item';
                    item.innerHTML = `
                        <div class="tarefa-info" onclick="viewAnimal(${tarefa.animalId})">
                            <strong>Cio de ${animalName} (${formatAnimalId(tarefa.animalId)})</strong>
                            <span class="tarefa-meta">Data Prevista: ${formatDate(tarefa.data)}</span>
                        </div>
                    `;
                    DOM.proximosCioLista.appendChild(item);
                });
            }
        }

        // Popula selects de animais em lactação (Produção de Leite)
        function populateVacaSelects() {
            const vacasEmLactacao = rebanhoData.animais.filter(a => a.statusReprodutivo === 'Em Lactação');
            
            // Limpa e repopula o select de leite
            DOM.leiteVacaSelect.innerHTML = '<option value="">Selecione a Vaca...</option>';
            vacasEmLactacao.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.id;
                option.textContent = `${formatAnimalId(animal.id)} - ${animal.nome}`;
                DOM.leiteVacaSelect.appendChild(option);
            });
            
            // Limpa e repopula o select de tarefas (inclui todos os animais)
            DOM.tarefaAnimalSelect.innerHTML = '<option value="">Selecione o Animal...</option>';
            rebanhoData.animais.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.id;
                option.textContent = `${formatAnimalId(animal.id)} - ${animal.nome}`;
                DOM.tarefaAnimalSelect.appendChild(option);
            });
             populateParentSelects();
        
        }
        function populateParentSelects(excludeId = null) {
            if (!DOM.parentPaiSelect || !DOM.parentMaeSelect) return;

            const makeOptions = (select) => {
                select.innerHTML = '<option value="">Nenhum</option>';
               rebanhoData.animais.forEach(animal => {
                    if (excludeId && animal.id === excludeId) return; // não permitir selecionar o próprio animal como pai/mãe
                    const opt = document.createElement('option');
                    opt.value = animal.id;
                    opt.textContent = `${formatAnimalId(animal.id)} - ${animal.nome}`;
                    select.appendChild(opt);
                });
            };

            makeOptions(DOM.parentPaiSelect);
            makeOptions(DOM.parentMaeSelect);
        }
        
        // Helper para exibir Pai/Mãe em listas
        function parentDisplay(id) {
            if (!id) return '—';
            return `${formatAnimalId(id)} - ${getAnimalName(id)}`;
        }
        // Combinação de todos os selectors
        function updateAllSelectors() {
            populateVacaSelects();
            populateParentSelects();
        }

        // --- Funções de Gráficos ---

        // Cria/Atualiza Gráfico de Produção Diária (Dashboard)
        function updateProducaoDiariaChart() {
            const dailyData = rebanhoData.producaoLeite.reduce((acc, curr) => {
                // Soma a produção do dia, ignorando o período
                acc[curr.data] = (acc[curr.data] || 0) + curr.quantidade;
                return acc;
            }, {});

            // Gera rótulos das últimas 4 semanas (28 dias)
            const labels = [];
            const dataPoints = [];
            for (let i = 27; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const isoDate = date.toISOString().split('T')[0];
                labels.push(formatDate(isoDate));
                dataPoints.push(dailyData[isoDate] || 0);
            }

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Produção Total Diária (Litros)',
                    data: dataPoints,
                    backgroundColor: 'rgba(40, 167, 69, 0.5)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1,
                    tension: 0.4,
                    fill: true
                }]
            };

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Litros (L)' } }
                    }
                }
            };

            if (producaoDiariaChart) {
                producaoDiariaChart.data = chartData;
                producaoDiariaChart.update();
            } else {
                producaoDiariaChart = new Chart(DOM.producaoDiariaChartCanvas, config);
            }
        }
        
        // Cria/Atualiza Gráfico de Distribuição do Rebanho
        function updateDistribuicaoRebanhoChart() {
            const counts = rebanhoData.animais.reduce((acc, curr) => {
                acc[curr.categoria] = (acc[curr.categoria] || 0) + 1;
                return acc;
            }, {});

            const categories = Object.keys(counts);
            const dataPoints = Object.values(counts);

            const chartData = {
                labels: categories,
                datasets: [{
                    data: dataPoints,
                    backgroundColor: [
                        '#007bff', // Vaca
                        '#28a745', // Novilha
                        '#ffc107', // Bezerro(a)
                        '#dc3545'  // Boi
                    ],
                    hoverOffset: 4
                }]
            };

            const config = {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            };

            if (distribuicaoRebanhoChart) {
                distribuicaoRebanhoChart.data = chartData;
                distribuicaoRebanhoChart.update();
            } else {
                distribuicaoRebanhoChart = new Chart(DOM.distribuicaoRebanhoChartCanvas, config);
            }
        }

        // Cria/Atualiza Gráfico de Produção do Animal (Modal View)
        function updateAnimalProducaoChart(animalId) {
            const animalProducao = rebanhoData.producaoLeite
                .filter(p => p.animalId === animalId)
                .sort((a, b) => new Date(a.data) - new Date(b.data));

            // Agrega por dia
            const dailyData = animalProducao.reduce((acc, curr) => {
                acc[curr.data] = (acc[curr.data] || 0) + curr.quantidade;
                return acc;
            }, {});
            
            // Exibe apenas os últimos 30 dias ou 30 pontos de dados únicos
            const uniqueDates = Object.keys(dailyData).sort().slice(-30);

            const labels = uniqueDates.map(date => formatDate(date));
            const dataPoints = uniqueDates.map(date => dailyData[date]);

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Produção Diária (L)',
                    data: dataPoints,
                    backgroundColor: 'rgba(0, 123, 255, 0.6)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1,
                    tension: 0.4,
                    pointRadius: 3,
                    fill: false
                }]
            };

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Litros (L)' } },
                        x: { display: true, title: { display: true, text: 'Data' } }
                    }
                }
            };

            if (animalProducaoChart) {
                animalProducaoChart.destroy(); // Destrói o anterior para garantir a atualização
            }
            animalProducaoChart = new Chart(DOM.animalProducaoChartCanvas, config);
            
            // Renderiza a lista de produção no modal
            renderAnimalProducaoList(animalProducao.slice(-15).reverse());
        }
        
        // Renderiza a lista de produção dentro do modal de visualização
        function renderAnimalProducaoList(producao) {
            DOM.animalProducaoList.innerHTML = '';
            producao.forEach(registro => {
                const row = DOM.animalProducaoList.insertRow();
                row.innerHTML = `
                    <td>${formatDate(registro.data)}</td>
                    <td>${registro.periodo.charAt(0).toUpperCase() + registro.periodo.slice(1)}</td>
                    <td>${registro.quantidade.toFixed(2)} L</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteLeiteRegistro(${registro.id})"><i class="ph ph-trash"></i></button>
                    </td>
                `;
            });
        }


        // --- Funções de Dashboard e Resumo ---

        // Atualiza as métricas e gráficos do Dashboard
        function updateDashboard() {
            // Métrica 1: Total de Animais
            DOM.totalAnimais.textContent = rebanhoData.animais.length;

            // Métrica 2: Vacas em Lactação
            const vacasEmLactacao = rebanhoData.animais.filter(a => a.statusReprodutivo === 'Em Lactação').length;
            DOM.vacasLactacao.textContent = vacasEmLactacao;
            
            // Métrica 3: Tarefas Pendentes (atualizado em renderTarefaList)
            renderTarefaList(); 

            // Métrica 4: Média Diária (Últimos 7 dias)
            let totalLitros7Dias = 0;
            const dailyData = rebanhoData.producaoLeite.reduce((acc, curr) => {
                acc[curr.data] = (acc[curr.data] || 0) + curr.quantidade;
                return acc;
            }, {});

            let daysWithProduction = 0;
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const isoDate = date.toISOString().split('T')[0];
                const amount = dailyData[isoDate] || 0;
                totalLitros7Dias += amount;
                if (amount > 0) daysWithProduction++;
            }
            
            const mediaDiaria = daysWithProduction > 0 ? (totalLitros7Dias / daysWithProduction) : 0;
            DOM.producaoMediaDiaria.textContent = `${mediaDiaria.toFixed(2)} L`;
            
            // Atualiza gráficos
            updateProducaoDiariaChart();
            updateDistribuicaoRebanhoChart();
            renderProximosEventosReprodutivos();
        }

        // --- Funções do Modal de Visualização de Animal ---

        // Função para visualização de animal (popula o modal)
        function viewAnimal(animalId) {
            const animal = rebanhoData.animais.find(a => a.id === animalId);
            if (!animal) {
                showCustomAlert('Erro', 'Animal não encontrado.', 'danger');
                return;
            }

            DOM.viewAnimalTitle.textContent = `Detalhes de ${animal.nome} (${formatAnimalId(animal.id)})`;
            DOM.btnEditView.dataset.animalId = animal.id;
            DOM.btnDeleteView.dataset.animalId = animal.id;

            // Detalhes
            DOM.viewAnimalDetails.innerHTML = `
                <dt>ID</dt><dd>${formatAnimalId(animal.id)}</dd>
                <dt>Sexo</dt><dd>${animal.sexo || 'N/D'}</dd>
                dt>Pai</dt><dd>${parentDisplay(animal.parentPaiId)}</dd>
                <dt>Mãe</dt><dd>${parentDisplay(animal.parentMaeId)}</dd>
                <dt>Raça</dt><dd>${animal.raca}</dd>
                <dt>Categoria</dt><dd>${animal.categoria}</dd>
                <dt>Idade</dt><dd>${calculateAge(animal.dataNasc)}</dd>
                <dt>Peso</dt><dd>${animal.peso} Kg</dd>
                <dt>Status Reprodutivo</dt><dd>${animal.statusReprodutivo || 'N/D'}</dd>
                <dt>Último Parto</dt><dd>${formatDate(animal.dataUltimoParto)}</dd>
                <dt>Previsão Parto</dt><dd>${formatDate(animal.dataPrevisaoParto)}</dd>
                <dt>DEL</dt><dd>${animal.dataUltimoParto ? calculateDaysInMilk(animal.dataUltimoParto) + ' dias' : 'N/D'}</dd>
                `;

            // Foto
            DOM.viewAnimalFoto.src = animal.fotoBase64 || PLACEHOLDER_FOTO;
            
            // Abas de Conteúdo
            setupAnimalViewTabs(animal);
            
            DOM.modalAnimalView.style.display = 'flex';
        }

        // Configura as abas de histórico, produção e lactação no modal de visualização
        function setupAnimalViewTabs(animal) {
            const tabs = DOM.animalViewTabsContainer.querySelectorAll('.animal-view-tab-btn');
            const contents = document.querySelectorAll('#modal-animal-view .animal-view-tab-content');
            
            // Função para alternar conteúdo da aba
            const switchTab = (tabName) => {
                tabs.forEach(btn => btn.classList.remove('active'));
                contents.forEach(content => content.style.display = 'none');
                
                const activeTab = document.querySelector(`.animal-view-tab-btn[data-tab="${tabName}"]`);
                const activeContent = document.getElementById(tabName);
                
                if (activeTab) activeTab.classList.add('active');
                if (activeContent) activeContent.style.display = 'block';

                // Renderização condicional
                if (tabName === 'producao-tab') {
                    updateAnimalProducaoChart(animal.id);
                } else if (tabName === 'historico') {
                    renderAnimalHistorico(animal);
                } else if (tabName === 'lactacoes') {
                    renderAnimalLactacoes(animal.id);
                }
            };
            
            // Adiciona listeners aos botões
            tabs.forEach(btn => {
                btn.onclick = () => switchTab(btn.dataset.tab);
            });
            
            // Mostra a primeira aba por padrão e renderiza seu conteúdo
            switchTab(tabs[0].dataset.tab);
        }

        // Renderiza a Timeline de Histórico de Eventos
        function renderAnimalHistorico(animal) {
            const timeline = DOM.animalHistoricoTimeline;
            timeline.innerHTML = '';
            
            // Coleta eventos
            let events = [];
            
            // Adiciona tarefas realizadas como eventos
            rebanhoData.tarefas
                .filter(t => t.animalId === animal.id && t.done && t.dataConclusao)
                .forEach(t => events.push({
                    date: t.dataConclusao,
                    type: t.tipo,
                    title: t.tipo.charAt(0).toUpperCase() + t.tipo.slice(1) + ' Realizado',
                    description: t.descricao || 'N/D'
                }));

            // Adiciona registros de lactação (parto) como evento
             rebanhoData.lactacoes
                .filter(l => l.animalId === animal.id)
                .forEach(l => events.push({
                    date: l.dataInicio,
                    type: 'parto',
                    title: `Início da Lactação (Parto)`,
                    description: `Duração: ${l.dataFim ? calculateDaysInMilk(l.dataInicio, l.dataFim) + ' dias' : 'Em curso'}. Total: ${l.totalLitros.toFixed(2)} L.`
                }));

            // Adiciona outros eventos de reprodução importantes do animal
            if (animal.dataAquisicao) {
                 events.push({
                    date: animal.dataAquisicao,
                    type: 'outro',
                    title: 'Aquisição do Animal',
                    description: `Animal adquirido na fazenda/mercado. Peso: ${animal.peso} Kg.`
                });
            }
            
            // Ordena os eventos por data (mais recente primeiro)
            events.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (events.length === 0) {
                 timeline.innerHTML = '<p class="text-secondary">Nenhum evento registrado para este animal.</p>';
                 return;
            }

            events.forEach(event => {
                const item = document.createElement('li');
                item.className = `timeline-item ${event.type}`;
                item.innerHTML = `
                    <div class="timeline-date">${formatDate(event.date)}</div>
                    <div class="timeline-content">
                        <h4>${event.title}</h4>
                        <p>${event.description}</p>
                    </div>
                `;
                timeline.appendChild(item);
            });
        }
        
        // Renderiza a Lista de Lactações (no modal de visualização)
        function renderAnimalLactacoes(animalId) {
            const tbody = DOM.animalLactacoesList;
            tbody.innerHTML = '';
            
            const lactacoes = rebanhoData.lactacoes
                .filter(l => l.animalId === animalId)
                .sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));

            if (lactacoes.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" class="text-secondary" style="text-align: center;">Nenhum registro de lactação.</td></tr>';
                 return;
            }

            lactacoes.forEach(lactacao => {
                const isCurrent = !lactacao.dataFim;
                const status = isCurrent ? 'Em Curso' : formatDate(lactacao.dataFim);
                const diasEmLactacao = isCurrent 
                    ? calculateDaysInMilk(lactacao.dataInicio)
                    : calculateDaysInMilk(lactacao.dataInicio, lactacao.dataFim); // Reusa a função para calcular diferença entre duas datas (melhoria)
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(lactacao.dataInicio)}</td>
                    <td>${status} (${diasEmLactacao} dias)</td>
                    <td>Parto (${formatDate(lactacao.dataInicio)})</td>
                    <td>${lactacao.totalLitros.toFixed(2)} L</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteLactacaoRegistro(${lactacao.id}, ${animalId})"><i class="ph ph-trash"></i></button>
                    </td>
                `;
            });
        }


        // --- Funções de Imagem/Câmera ---

        function previewFoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    DOM.fotoPreview.src = e.target.result;
                    DOM.fotoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                DOM.fotoPreview.src = PLACEHOLDER_FOTO;
                DOM.fotoPreview.style.display = 'none';
            }
        }

        function capturarImagem() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Esconde o input de arquivo e o preview
                DOM.animalFotoInput.style.display = 'none';
                DOM.fotoPreview.style.display = 'none';
                
                // Mostra vídeo, canvas e botões da câmera
                DOM.cameraVideo.style.display = 'block';
                DOM.btnTirarFoto.style.display = 'inline-flex';
                DOM.btnCancelarCamera.style.display = 'inline-flex';
                
                // Inicia o stream da câmera
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }) // Prioriza câmera traseira
                    .then(stream => {
                        videoStream = stream;
                        DOM.cameraVideo.srcObject = stream;
                    })
                    .catch(err => {
                        console.error("Erro ao acessar a câmera: ", err);
                        showCustomAlert('Erro de Câmera', 'Não foi possível acessar a câmera do dispositivo.', 'danger');
                        cancelarCaptura();
                    });
            } else {
                 showCustomAlert('Erro', 'Seu navegador não suporta acesso à câmera.', 'danger');
            }
        }

        function tirarFoto() {
            if (videoStream) {
                // Configura o canvas para a dimensão do vídeo
                DOM.cameraCanvas.width = DOM.cameraVideo.videoWidth;
                DOM.cameraCanvas.height = DOM.cameraVideo.videoHeight;
                
                // Desenha o frame do vídeo no canvas
                const context = DOM.cameraCanvas.getContext('2d');
                context.drawImage(DOM.cameraVideo, 0, 0, DOM.cameraCanvas.width, DOM.cameraCanvas.height);
                
                // Converte o conteúdo do canvas para Base64 (JPG)
                const dataUrl = DOM.cameraCanvas.toDataURL('image/jpeg', 0.8);
                
                // Define a imagem capturada como o preview
                DOM.fotoPreview.src = dataUrl;
                DOM.fotoPreview.style.display = 'block';
                
                // Finaliza e esconde a câmera
                cancelarCaptura(false); // Não mostra alerta de cancelamento
            }
        }

        function cancelarCaptura(showManualInput = true) {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // Esconde elementos da câmera
            DOM.cameraVideo.style.display = 'none';
            DOM.btnTirarFoto.style.display = 'none';
            DOM.btnCancelarCamera.style.display = 'none';

            // Mostra o input de arquivo novamente
            DOM.animalFotoInput.style.display = 'block';
            
            // Se não houver preview, mostra o placeholder
            if (showManualInput && !DOM.fotoPreview.src) {
                DOM.fotoPreview.src = PLACEHOLDER_FOTO;
                DOM.fotoPreview.style.display = 'none';
            }
        }


        // --- Funções de Importação/Exportação/Reset ---

        // Exporta todos os dados (JSON)
        function exportDataToJson() {
            const dataStr = JSON.stringify(rebanhoData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rebanho_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showCustomAlert('Sucesso', 'Dados exportados em formato JSON!', 'success');
        }

        // Importa dados a partir de um JSON
        function importDataFromJson(jsonString) {
            try {
                const newData = JSON.parse(jsonString);
                
                // Validação básica para garantir a estrutura
                if (!Array.isArray(newData.animais) || !Array.isArray(newData.producaoLeite)) {
                    throw new Error("Estrutura de dados JSON inválida.");
                }
                
                rebanhoData = newData;
                // Garante que o nextAnimalId existe e é o maior ID + 1
                const maxId = rebanhoData.animais.reduce((max, animal) => Math.max(max, animal.id), 0);
                rebanhoData.nextAnimalId = maxId + 1;
                
                saveData();
                showCustomAlert('Sucesso', 'Dados JSON importados e restaurados!', 'success');
                DOM.inputImportarDados.value = ''; // Limpa o input
                initialSetup(); // Re-inicializa a aplicação
            } catch (error) {
                console.error("Erro na importação JSON:", error);
                showCustomAlert('Erro de Importação', `Falha ao importar o arquivo JSON: ${error.message}`, 'danger');
            }
        }
        
        // Exporta a lista de animais para CSV
        function exportToCsv() {
             const animais = rebanhoData.animais;
             if (animais.length === 0) {
                 showCustomAlert('Atenção', 'Não há animais para exportar.', 'warning');
                 return;
             }

             // Colunas: ID, Nome, Sexo, Raça, Categoria, Peso, DataNasc, DataAquisicao, StatusReprodutivo, DataUltimoParto, DataSecagem, DataPrevisaoParto
             const header = ["ID","Nome","Sexo","Raça","Categoria","Peso","DataNasc","DataAquisicao","StatusReprodutivo","DataUltimoParto","DataSecagem","DataPrevisaoParto"];
             
             const csvContent = "data:text/csv;charset=utf-8," 
                                + header.join(",") + "\n"
                                + animais.map(a => 
                                    [
                                        formatAnimalId(a.id),
                                        `"${(a.nome||'').replace(/"/g,'""')}"`,
                                        a.sexo || '',
                                        a.raca || '',
                                        a.categoria || '',
                                        a.peso || '',
                                        a.dataNasc || '',
                                        a.dataAquisicao || '',
                                        a.statusReprodutivo || '',
                                        a.dataUltimoParto || '',
                                        a.dataSecagem || '',
                                        a.dataPrevisaoParto || ''
                                    ].join(",")
                                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `animais_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link);
            showCustomAlert('Sucesso', 'Lista de animais exportada para CSV!', 'success');
        }

        // Função para importar CSV (Animais)
     function importDataFromCsv(csvString) {
             const lines = csvString.trim().split('\n');
             if (lines.length <= 1) {
                 showCustomAlert('Erro', 'O arquivo CSV está vazio ou tem apenas o cabeçalho.', 'danger');
                 return;
             }
             
             // Espera-se: ID, Nome, Sexo, Raça, Categoria, Peso, DataNasc, DataAquisicao, StatusReprodutivo, DataUltimoParto, DataSecagem, DataPrevisaoParto
             const newAnimals = [];
             let currentMaxId = rebanhoData.nextAnimalId - 1;

             for (let i = 1; i < lines.length; i++) {
                 const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, '')); // Remove aspas
                 if (values.length < 12) continue; // Pula linhas incompletas

                 // Tenta usar o ID do CSV, ou gera um novo (se o ID for inválido ou zero)
                 let idFromCsv = parseInt(values[0].replace(/[^0-9]/g, ''));
                 let animalId = isNaN(idFromCsv) || idFromCsv === 0 ? rebanhoData.nextAnimalId++ : idFromCsv;

                 // Garante que o novo ID seja o maior se for importado com um ID maior que o nextAnimalId
                 if (animalId >= rebanhoData.nextAnimalId) {
                    rebanhoData.nextAnimalId = animalId + 1;
                 } else if (animalId > currentMaxId) {
                    currentMaxId = animalId;
                 }

                 newAnimals.push({
                     id: animalId,
                     nome: values[1] || `Anim${animalId}`,
                     sexo: values[2] || 'Indefinido',
                     raca: values[3] || '',
                     categoria: values[4] || classifyCategory(values[6], values[2]), // tenta classificar pela dataNasc caso categoria vazia
                     peso: parseFloat(values[5]) || 0,
                     dataNasc: values[6] || '',
                     dataAquisicao: values[7] || null,
                     statusReprodutivo: values[8] || 'Vazia',
                     dataUltimoParto: values[9] || null,
                     dataSecagem: values[10] || null,
                     dataPrevisaoParto: values[11] || null,
                     fotoBase64: null,
                     lactacoes: [] // Começa sem registros de lactação associados ao import CSV
                 });
             }
             
             // Adiciona novos animais, mas verifica duplicatas por nome (opcional, aqui apenas adiciona)
             rebanhoData.animais = rebanhoData.animais.concat(newAnimals);
             rebanhoData.nextAnimalId = rebanhoData.nextAnimalId > currentMaxId ? rebanhoData.nextAnimalId : currentMaxId + 1;
             
             saveData();
             DOM.modalImportarCsv.style.display = 'none';
             showCustomAlert('Sucesso', `${newAnimals.length} animais importados via CSV!`, 'success');
             initialSetup();
        }

        // Reseta todos os dados
        function resetAllData() {
            showCustomConfirm('Confirmar Reset Total', 'Tem certeza que deseja apagar TODOS os dados da aplicação? Esta ação é IRREVERSÍVEL.', () => {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem('idPrefix');
                rebanhoData = { animais: [], producaoLeite: [], tarefas: [], lactacoes: [], nextAnimalId: 1 };
                initialSetup();
                showCustomAlert('Reset Concluído', 'Todos os dados foram apagados. A aplicação foi resetada.', 'success');
            }, () => {
                showCustomAlert('Cancelado', 'O reset de dados foi cancelado.', 'info');
            });
        }
        
        // --- Setup Inicial ---

        function setupEventListeners() {
            // Navegação
            DOM.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(link.getAttribute('data-section'));
                });
            });
            
            if (DOM.animalDataNascInput) DOM.animalDataNascInput.addEventListener('change', updateCategoryFromDobSex);
            if (DOM.animalSexoSelect) DOM.animalSexoSelect.addEventListener('change', updateCategoryFromDobSex);
            
            // Formulários
            DOM.animalForm.addEventListener('submit', saveAnimal);
            DOM.leiteForm.addEventListener('submit', saveLeite);
            DOM.tarefaForm.addEventListener('submit', saveTarefa);
            DOM.idPrefixForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const prefix = DOM.idPrefixInput.value.trim().toUpperCase();
                if (prefix.length >= 1 && prefix.length <= 5) {
                    localStorage.setItem('idPrefix', prefix);
                    DOM.currentIdPrefix.textContent = prefix;
                    showCustomAlert('Sucesso', `Prefixo de ID alterado para ${prefix}.`, 'success');
                    renderAnimalList(); // Atualiza a lista para refletir o novo formato
                } else {
                    showCustomAlert('Erro', 'O prefixo deve ter entre 1 e 5 letras.', 'danger');
                }
            });

            // Filtros da Lista de Animais
            DOM.filtroCategoriaSelect.addEventListener('change', renderAnimalList);
            DOM.buscaAnimalInput.addEventListener('input', renderAnimalList);
            
            // Botões de Ação
            DOM.resetDataBtn.addEventListener('click', resetAllData);
            DOM.btnExportarJson.addEventListener('click', exportDataToJson);
            DOM.btnExportarCsv.addEventListener('click', exportToCsv);
            DOM.btnImportarDados.addEventListener('click', () => {
                const file = DOM.inputImportarDados.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => importDataFromJson(e.target.result);
                    reader.readAsText(file);
                } else {
                    showCustomAlert('Erro', 'Selecione um arquivo JSON para importar.', 'danger');
                }
            });
            DOM.inputImportarDados.addEventListener('change', () => {
                DOM.btnImportarDados.disabled = !DOM.inputImportarDados.files.length;
            });
            
            // Câmera
            DOM.btnTirarFoto.addEventListener('click', tirarFoto);
            DOM.btnCancelarCamera.addEventListener('click', cancelarCaptura);
            
            // Ações do Modal de Visualização
            DOM.btnEditView.addEventListener('click', (e) => openAnimalForm(parseInt(e.currentTarget.dataset.animalId)));
            DOM.btnDeleteView.addEventListener('click', (e) => deleteAnimal(parseInt(e.currentTarget.dataset.animalId)));

            // Modais de Importação
            DOM.btnImportarDadosModal.addEventListener('click', () => {
                 showSection('config'); // Vai para a seção de config
                 // Não abre modal, pois o input está diretamente na seção
            });
            
            DOM.btnImportarCsvModal.addEventListener('click', () => {
                 DOM.modalImportarCsv.style.display = 'flex';
                 DOM.inputImportarCsv.value = '';
                 DOM.btnImportarCsv.disabled = true;
            });

            DOM.inputImportarCsv.addEventListener('change', () => {
                 DOM.btnImportarCsv.disabled = !DOM.inputImportarCsv.files.length;
            });
            
            DOM.btnImportarCsv.addEventListener('click', () => {
                const file = DOM.inputImportarCsv.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => importDataFromCsv(e.target.result);
                    reader.readAsText(file);
                }
            });

            // NOVO: Lógica para o novo modal de relatórios
            DOM.btnAbrirModalRelatorio.addEventListener('click', () => {
                DOM.modalRelatoriosPdf.style.display = 'flex';
                // Limpar filtros e selecionar o primeiro item ao abrir
                DOM.formRelatorioPdf.reset();
                DOM.tipoRelatorioSelect.value = ''; // Garante que o select 'Selecione o Tipo...' está ativo
                toggleRelatorioFilters();
            });

            DOM.formRelatorioPdf.addEventListener('submit', (e) => {
                e.preventDefault();
                const tipo = DOM.tipoRelatorioSelect.value;
                if (!tipo) {
                    showCustomAlert('Erro', 'Por favor, selecione um tipo de relatório.', 'warning');
                    return;
                }
                const filtros = collectRelatorioFilters(tipo);
                DOM.modalRelatoriosPdf.style.display = 'none';
                generateReportPdf(tipo, filtros);
            });
        }

        function initialSetup() {
            loadData();
            setupEventListeners();
            
            // Configurações iniciais de UI
            showSection('dashboard');
            DOM.currentIdPrefix.textContent = localStorage.getItem('idPrefix') || 'ID';
            DOM.leiteDataInput.value = new Date().toISOString().split('T')[0];
            DOM.tarefaData.value = new Date().toISOString().split('T')[0];
            
            // Corrige o bug de campos de reprodução ao carregar o form para novo animal
             if (DOM.animalCategoriaSelect && DOM.vacaFields) {
                const categoria = DOM.animalCategoriaSelect.value;
                DOM.vacaFields.style.display = (categoria === 'Vaca' || categoria === 'Novilha') ? 'block' : 'none';
            }
            
            updateAllSelectors();
            renderAnimalList();
            renderLeiteList();
            renderTarefaList();
            updateDashboard();
        };

        // Chama a função principal para iniciar a aplicação
        window.onload = initialSetup;

        // Exposição de funções globais para handlers inline no HTML (necessário)
        window.viewAnimal = viewAnimal;
        window.editAnimal = openAnimalForm;
        window.deleteAnimal = deleteAnimal;
        window.previewFoto = previewFoto;
        window.capturarImagem = capturarImagem;
        window.openAnimalForm = openAnimalForm;
        window.showCustomAlert = showCustomAlert;
        window.showCustomConfirm = showCustomConfirm;
        window.exportDataToJson = exportDataToJson;
        window.importDataFromJson = importDataFromJson; 
        window.importDataFromCsv = importDataFromCsv; 
        window.resetAllData = resetAllData;
        
        // NOVO: Exposição das funções de relatório e utilitários
        window.generateReportPdf = generateReportPdf; // Substituído
        window.exportToCsv = exportToCsv;
        window.markTarefaAsDone = markTarefaAsDone;
        window.deleteTarefa = deleteTarefa;
        window.deleteLeiteRegistro = deleteLeiteRegistro;
        window.deleteLactacaoRegistro = deleteLactacaoRegistro;
        window.toggleRelatorioFilters = toggleRelatorioFilters; // NOVO
        
        // Função utilitária para calcular a diferença de dias entre duas datas (melhoria)
        function calculateDaysInMilk(startDate, endDate = null) {
            if (!startDate) return 0;
            const start = new Date(startDate + "T00:00:00");
            const end = endDate ? new Date(endDate + "T00:00:00") : new Date();

            if (start > end) return 0;
            const diffTime = Math.abs(end.getTime() - start.getTime());
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

    </script>
</body>
</html>
